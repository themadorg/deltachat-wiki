---
title: راه‌اندازی رله chatmail
description: تمام آنچه برای راه‌اندازی یک رله chatmail آماده استفاده نیاز دارید.
category: سرورها
---

<script>
    import Steps from '$lib/components/Steps.svelte';
    import Step from '$lib/components/Step.svelte';
</script>

# راه‌اندازی رله chatmail

این بخش شامل تمام مواردی است که برای راه‌اندازی یک رله chatmail آماده استفاده نیاز دارید.
راه‌اندازی خودکار برای ارائه آدرس‌های chatmail جهت ورود فوری و بدون نیاز به اجازه (permission-free) از طریق اپلیکیشن‌های چت و بات‌ها طراحی و بهینه‌سازی شده است.
آدرس‌های chatmail در اولین ورود به‌طور خودکار ایجاد می‌شوند و پس از آن، رمز عبور مشخص شده اولیه برای ارسال و دریافت پیام از طریق آن‌ها مورد نیاز است.

## حداقل الزامات و پیش‌نیازها

شما به موارد زیر نیاز دارید:

- **کنترل روی یک دامنه** از طریق یک ارائه‌دهنده DNS به انتخاب خودتان.
- یک **سرور با سیستم‌عامل Debian 12** با پورت‌های SMTP/SUBMISSIONS/IMAPS/HTTPS قابل دسترس. استفاده از IPv6 در صورت امکان توصیه می‌شود. سرورهای رله chatmail تنها به ۱ گیگابایت رم، یک پردازنده و حدود ۱۰ گیگابایت فضای ذخیره‌سازی برای چند هزار آدرس فعال نیاز دارند.
- یک **ماشین ساخت (Build Machine) با لینوکس یا یونیکس** که دسترسی SSH مبتنی بر کلید (key-based) به کاربر root سرور اصلی داشته باشد. شما باید یک کلید خصوصی محافظت شده با رمز (passphrase) را به ssh-agent محلی خود اضافه کنید، زیرا نمی‌توانید در طول فرآیند استقرار رمز خود را تایپ کنید. (به دلیل یک [باگ در پکیج پایتونی paramiko](https://github.com/paramiko/paramiko/issues/2191)، استفاده از کلید ed25519 الزامی است).

## راه‌اندازی با scripts/cmdeploy

ما در مراحل زیر از `chat.example.org` به‌عنوان دامنه chatmail استفاده می‌کنیم. لطفاً آن را با دامنه خود جایگزین کنید.

<Steps>
<Step number="1" title="تنظیم رکوردهای اولیه DNS">

رکوردهای اولیه DNS را برای سرور خود تنظیم کنید. مثال زیر در فرمت استاندارد BIND zone با زمان حیات (TTL) یک ساعت (۳۶۰۰ ثانیه) آورده شده است. لطفاً دامنه و آدرس‌های IP خود را جایگزین کنید.

```text
chat.example.org. 3600 IN A 198.51.100.5
chat.example.org. 3600 IN AAAA 2001:db8::5
www.chat.example.org. 3600 IN CNAME chat.example.org.
mta-sts.chat.example.org. 3600 IN CNAME chat.example.org.
```

</Step>
<Step number="2" title="کلون کردن مخزن">

مخزن را کلون کنید و محیط مجازی پایتون را روی کامپیوتر محلی خود آماده کنید:

```sh
git clone https://github.com/chatmail/relay
cd relay
scripts/initenv.sh
```

</Step>
<Step number="3" title="ایجاد فایل پیکربندی">

یک فایل پیکربندی chatmail با نام `chatmail.ini` روی ماشین ساخت محلی خود ایجاد کنید:

```sh
scripts/cmdeploy init chat.example.org  # <-- از دامنه خود استفاده کنید
```

</Step>
<Step number="4" title="تأیید ورود SSH">

تأیید کنید که ورود SSH به کاربر root سرور هدف کار می‌کند:

```sh
ssh root@chat.example.org  # <-- از دامنه خود استفاده کنید
```

</Step>
<Step number="5" title="نصب و پیکربندی" isLast={true}>

نصب و پیکربندی سرور از راه دور:

```sh
scripts/cmdeploy run
```

این اسکریپت همچنین بررسی می‌کند که آیا تمام رکوردهای DNS لازم را دارید یا خیر. در صورت نبود برخی رکوردها، توصیه می‌کند کدام موارد را باید در پنل DNS خود تنظیم کنید.

</Step>
</Steps>

## سایر دستورات مفید

برای بررسی وضعیت سرور مستقر شده:
```sh
scripts/cmdeploy status
```

برای نمایش و بررسی تمام رکوردهای DNS پیشنهادی:
```sh
scripts/cmdeploy dns
```

برای تست اینکه آیا سرویس chatmail شما به‌درستی کار می‌کند:
```sh
scripts/cmdeploy test
```

برای اندازه‌گیری عملکرد سرویس chatmail خود:
```sh
scripts/cmdeploy bench
```

## تغییر صفحه اصلی (Home Page)

دستور `cmdeploy run` همچنین صفحات وب استاتیک پیش‌فرضی ایجاد کرده و آن‌ها را روی وب‌سرور Nginx مستقر می‌کند:
- `index.html`: صفحه اصلی پیش‌فرض با یک کد QR برای ورود آسان.
- `info.html`: لینک شده از صفحه اصلی.
- `policy.html`: صفحه سیاست حریم خصوصی.

تمام فایل‌های `.html` از فایل‌های مارک‌دان (`.md`) متناظر در دایرکتوری `www/src` تولید می‌شوند.

## ویرایش صفحات وب

```sh
scripts/cmdeploy webdev
```
این دستور یک چرخه توسعه زنده محلی برای صفحات وب chatmail شروع می‌کند و به شما اجازه می‌دهد تغییرات را به‌صورت لحظه‌ای پیش‌نمایش کنید.

## صفحات وب سفارشی

شما می‌توانید با تنظیم `www_folder=disabled` در فایل `chatmail.ini` از آپلود صفحه وب صرف‌نظر کنید.
برای استفاده از یک دایرکتوری سفارشی برای صفحات وب خود، `www_folder` را روی آن دایرکتوری تنظیم کنید. دستور `cmdeploy run` آن را به‌عنوان صفحه اصلی سرور آپلود خواهد کرد.

## غیرفعال کردن ایجاد خودکار آدرس

اگر نیاز دارید ایجاد آدرس‌های جدید را متوقف کنید، از طریق SSH به سرور متصل شده و اجرا کنید:
```sh
touch /etc/chatmail-nocreate
```

## انتقال به یک ماشین ساخت جدید

برای انتقال یا افزودن یک ماشین ساخت، مخزن را در ماشین جدید کلون کنید و فایل `chatmail.ini` را از ماشین قبلی کپی کنید. اطمینان حاصل کنید که `rsync` نصب است، سپس:

```sh
./scripts/initenv.sh
./scripts/cmdeploy dns
./scripts/cmdeploy status
```
