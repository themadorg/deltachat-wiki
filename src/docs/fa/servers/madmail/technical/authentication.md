---
title: مشخصات احراز هویت
description: جزئیات فنی ثبت‌نام در لحظه (JIT) و منطق احراز هویت در Madmail.
category: فنی
---

# مشخصات احراز هویت Chatmail

## نمای کلی
Chatmail الگوی ثبت‌نام «در لحظه» یا Just-In-Time را پیاده‌سازی می‌کند. برخلاف سرورهای سنتی ایمیل که نیاز به ایجاد دستی حساب کاربری دارند، Chatmail اجازه می‌دهد حساب‌ها به‌طور خودکار در اولین تلاش موفق برای احراز هویت (از طریق IMAP یا SMTP Submission) ایجاد شوند.

## منطق احراز هویت
منطق اصلی در ماژول `auth.pass_table` (فایل `internal/auth/pass_table/table.go`) قرار دارد.

### سناریو: ورود کاربر (IMAP/SMTP)
۱. **نرمال‌سازی**: نام کاربری با استفاده از PRECIS نرمال‌سازی می‌شود (تبدیل به حروف کوچک و پاک‌سازی).
۲. **جستجوی اطلاعات**: سیستم تلاش می‌کند کاربر را در جدول `passwords` پیدا کند.
۳. **منطق انشعاب**:
    *   **کاربر وجود دارد**: تأیید رمز عبور استاندارد انجام می‌شود (مقایسه هش Bcrypt).
    *   **کاربر وجود ندارد**:
        *   سیستم وضعیت ثبت‌نام JIT را استعلام می‌کند (`__JIT_REGISTRATION_ENABLED__`).
        *   اگر `__JIT_REGISTRATION_ENABLED__` برابر با `true` باشد:
            *   یک ورودی جدید برای کاربر بلافاصله ایجاد می‌شود.
            *   رمز عبور ارائه شده هش شده و ذخیره می‌گردد.
            *   اجازه ورود صادر می‌شود.
        *   اگر `__JIT_REGISTRATION_ENABLED__` برابر با `false` باشد:
            *   تلاش برای ورود با خطای `Invalid Credentials` رد می‌شود.

## جزئیات پیاده‌سازی فنی

### معماری ماژول
- **ارائه‌دهنده احراز هویت**: `internal/auth/pass_table`
- **بک‌اِند ذخیره‌سازی**: `internal/storage/imapsql`
- **مدیریت پرچم‌ها**: `internal/table/sql_table`

### پیکربندی داینامیک (جدول تنظیمات)
پرچم‌های کل سیستم از اطلاعات کاربران جدا شده‌اند تا عملکرد حفظ شود و از تداخل اسکیما جلوگیری گردد:
- **نام جدول**: `settings` (یا طبق آنچه در `maddy.conf` از طریق `settings_table` تنظیم شده).
- **جفت کلید-مقدار**: `__REGISTRATION_OPEN__` -> `"true"`/`"false"`.
- **اولویت**: اگر کلید در جدول نباشد، سیستم به مقدار استاتیک `auto_create` تعریف شده در `maddy.conf` رجوع می‌کند.

پرچم ثبت‌نام JIT (`__JIT_REGISTRATION_ENABLED__`) ایجاد خودکار حساب را کنترل می‌کند. اگر صریحاً تنظیم نشده باشد، به‌طور پیش‌فرض از مقدار `__REGISTRATION_OPEN__` استفاده می‌کند.

### آماده‌سازی صندوق پستی
وقتی یک کاربر در هنگام ورود به‌طور خودکار ثبت‌نام می‌شود، صندوق پستی IMAP او در اولین دسترسی یا اولین تحویل ایمیل به‌صورت تنبل (Lazy provisioning) آماده می‌شود.
- **هوک تحویل**: فایل `internal/storage/imapsql/delivery.go` همچنین وضعیت ثبت‌نام JIT را بررسی می‌کند تا تعیین کند آیا یک گیرنده غیرموجود باید در طول تحویل ایمیل ورودی به‌طور خودکار ایجاد شود یا خیر.

## مقایسه JIT و ثبت‌نام از طریق API

Chatmail از دو روش اصلی برای ایجاد حساب‌ها پشتیبانی می‌کند:

۱.  **JIT (در لحظه)**: با تلاش برای ورود فعال می‌شود.
    - **مزایا**: اصطکاک صفر برای کاربران.
    - **معایب**: می‌تواند منجر به «تصاحب آدرس» یا ایجاد تصادفی حساب شود اگر رمز عبور با سیاست‌های مورد نظر مطابقت نداشته باشد.
۲.  **مبتنی بر API (مسیر `/new`)**: با یک درخواست POST به نقطه انتهایی وب فعال می‌شود.
    - **مزایا**: به سرور اجازه می‌دهد تولید نام کاربری را کنترل کرده و قبل از تلاش کلاینت برای ورود، از یکتا بودن آن اطمینان حاصل کند.
    - **جریان کنترل شده**: حتی اگر `__JIT_REGISTRATION_ENABLED__` غیرفعال (`false`) باشد، API مسیر `/new` تا زمانی که `__REGISTRATION_OPEN__` فعال (`true`) باشد، همچنان کار خواهد کرد. این به مدیران اجازه می‌دهد ایجاد خودکار در هنگام ورود را غیرفعال کنند در حالی که همچنان به کاربران جدید اجازه می‌دهند از طریق صفحه رسمی وب ثبت‌نام کنند.

## مدیریت از طریق خط فرمان (CLI)
وضعیت ثبت‌نام را می‌توان بدون راه‌اندازی مجدد سرور تغییر داد:
```bash
maddy creds registration open   # تنظیم __REGISTRATION_OPEN__ روی true
maddy creds registration close  # تنظیم __REGISTRATION_OPEN__ روی false
```

ثبت‌نام JIT را می‌توان به‌طور مستقل مدیریت کرد:
```bash
maddy creds jit enable   # فعال کردن ایجاد خودکار حساب
maddy creds jit disable  # غیرفعال کردن ایجاد خودکار حساب
maddy creds jit status   # نمایش وضعیت فعلی ثبت‌نام JIT
```
