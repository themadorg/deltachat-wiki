---
title: مجموعه تست E2E
description: توضیحات دقیق مجموعه تست E2E دلتاچت که برای تأیید رفتار و پروتکل‌های Madmail استفاده می‌شود.
category: فنی
---

# مجموعه تست E2E دلتاچت برای Madmail

این سند مجموعه تست‌های سرتاسری (end-to-end یا E2E) برای سرور Madmail را توصیف می‌کند که از کلاینت RPC دلتاچت برای شبیه‌سازی تعاملات واقعی کاربران و تأیید رفتار سرور استفاده می‌کند.

## اجرای تست‌ها

### تست‌های سرتاسری (E2E)
مجموعه اصلی E2E از دلتاچت برای تأیید رفتارهای واقعی استفاده می‌کند:

```bash
make test
```

این دستور اجراکننده تست را با استفاده از `uv` فراخوانی می‌کند:
`uv run python3 tests/deltachat-test/main.py`

### تست‌های واحد (Unit Tests)
برای منطق داخلی زبان Go، می‌توانید تست‌های واحد را اجرا کنید:

```bash
make test-unit
```

### تست انتخابی E2E

می‌توانید تست‌های خاص یا تمام تست‌ها را با استفاده از آرگومان‌های خط فرمان اجرا کنید:

```bash
# اجرای تمام تست‌ها (پیش‌فرض)
uv run python3 tests/deltachat-test/main.py --all

# اجرای تست‌های خاص
uv run python3 tests/deltachat-test/main.py --test-1 --test-3
```

## سناریوهای تست

این مجموعه شامل چندین سناریو است که در مسیر `tests/deltachat-test/scenarios/` قرار دارند:

### ۱. ایجاد حساب کاربری (`test_01_account_creation.py`)
- حساب‌های تست تصادفی روی سرورهای ایمیل مشخص شده ایجاد می‌کند.
- از فرمت `dclogin` برای تعیین صریح هاست‌های IMAP/SMTP و دور زدن جستجوی DNS استفاده می‌کند.
- تأیید می‌کند که حساب می‌تواند به‌درستی پیکربندی شده و تبادل داده را آغاز کند.

### ۲. رد کردن پیام‌های غیررمزنگاری شده (`test_02_unencrypted_rejection.py`)
- تلاش برای ارسال یک ایمیل متن ساده (غیررمزنگاری شده) از طریق SMTP.
- تأیید می‌کند که سرور Madmail به‌درستی آن را با کد خطای **523 "Encryption Needed"** رد می‌کند.
- این کار تضمین می‌کند که سرور سیاست «فقط PGP» را اعمال می‌کند.

### ۳. تلاش برای Secure Join (`test_03_secure_join.py`)
- دست‌دادن Secure Join را بین دو حساب انجام می‌دهد.
- تأیید می‌کند که هر دو طرف به «مخاطبان تأیید شده» تبدیل شده و یک کانال امن و رمزنگاری شده با PGP برقرار می‌کنند.

### ۴. پیام رمزنگاری شده P2P
- یک پیام همتا‌به‌همتا رمزنگاری شده بین دو حساب تأیید شده ارسال می‌کند.
- تحویل موفقیت‌آمیز و رمزگشایی در سمت گیرنده را تأیید می‌کند.

### ۵. ایجاد گروه و ارسال پیام (`test_05_group_message.py`)
- یک چت گروهی چندکاربره جدید ایجاد می‌کند.
- یک مخاطب تأیید شده دیگر را به گروه اضافه می‌کند.
- تأیید می‌کند که پیام‌های گروه به‌درستی توزیع شده و توسط اعضا دریافت می‌شوند.

### ۶. انتقال فایل (`test_06_file_transfer.py`)
- یک فایل تصادفی ۱ مگابایتی ایجاد می‌کند.
- فایل را از طریق دلتاچت ارسال می‌کند.
- یکپارچگی فایل دریافت شده را با مقایسه **هش SHA256** آن با فایل اصلی تأیید می‌کند.

### ۷. فدراسیون (اتصال بین سرورها) (`test_07_federation.py`)
- ارسال پیام بین حساب‌های موجود در نمونه‌های مختلف Madmail را تأیید می‌کند.
- ارسال پیام بین دو حساب روی یک نمونه واحد را تأیید می‌کند.
- اطمینان حاصل می‌کند که رمزنگاری PGP و تحویل پیام در مرزهای سرور به‌درستی کار می‌کند.

### ۸. تست عدم ثبت لاگ (`test_08_no_logging.py`)
- این تست ماهیت «اولویت حریم خصوصی» سرور را تأیید می‌کند.
- به‌طور خودکار ثبت لاگ را روی سرورهای راه دور از طریق SSH غیرفعال می‌کند.
- حجم زیادی از پیام‌ها (بیش از ۳۰ عدد) را در سناریوهای P2P، گروهی و فدراسیون ارسال می‌کند.
- `journalctl` را بررسی می‌کند تا مطمئن شود هیچ (یا حداقل) لاگی در طول این عملیات تولید نشده است.
- پس از اتمام، ثبت لاگ را دوباره به‌طور خودکار فعال می‌کند.

### ۹. انتقال فایل‌های بزرگ (`test_09_send_bigfile.py`)
- خط لوله SMTP/IMAP را با چندین فایل پیوست بزرگ تست فشار (Stress test) می‌کند.
- تأیید می‌کند که محدودیت‌های `appendlimit` و `max_message_size` به‌درستی اعمال و مدیریت می‌شوند.

### ۱۰. امضای فایل اجرایی و ارتقا (`test_10_upgrade_mechanism.py`)
- یکپارچگی مکانیزم ارتقای فایل اجرایی را تأیید می‌کند.
- هر دو مورد ارتقای موفقیت‌آمیز امضا شده و رد کردن فایل‌های اجرایی بدون امضا یا دست‌کاری شده را تست می‌کند.
- به‌روزرسانی‌ها را هم از فایل‌های محلی و هم از آدرس‌های URL دور دست شبیه‌سازی می‌کند.

### ۱۱. ثبت‌نام JIT (در لحظه) (`test_11_jit_registration.py`)
- ایجاد حساب کاربری «در لحظه» را تأیید می‌کند.
- یک حساب برای اولین بار که ایمیلی دریافت می‌کند یا زمانی که کاربر سعی می‌کند وارد شود، بدون نیاز به ثبت‌نام دستی قبلی، به‌طور خودکار ایجاد می‌شود.

### ۱۲. تست SMTP/IMAP IDLE (`test_12_smtp_imap_idle.py`)
- پاسخگویی پیاده‌سازی IMAP IDLE را تأیید می‌کند.
- دریافت پیام‌ها به‌صورت لحظه‌ای و بدون نیاز به پرس‌وجو (polling) را تست می‌کند.
- اطمینان حاصل می‌کند که تحویل SMTP نوتیفیکیشن‌های IDLE را به‌درستی فعال می‌کند.

### ۱۴. پاک‌سازی پیام‌ها (`test_14_purge_messages.py`)
- دستورات مدیریتی برای پاک‌سازی داده‌های کاربران را تأیید می‌کند.
- `purge-read` (حذف پیام‌های علامت‌گذاری شده به‌عنوان دیده شده) را تست می‌کند.
- `purge-all` (پاک‌سازی کامل صندوق پستی یک حساب) را تست می‌کند.
- بازیابی فضای ذخیره‌سازی را از طریق آمار سمت سرور تأیید می‌کند.

### ۱۵. کشف Iroh (`test_15_iroh_discovery.py`)
- تأیید می‌کند که سرور به‌درستی آدرس URL رله Iroh را از طریق IMAP METADATA اعلام می‌کند.
- اطمینان حاصل می‌کند کلاینت می‌تواند آدرس رله را برای برقراری اتصال P2P دریافت و تجزیه کند.

### ۱۶. ارتباط WebXDC Realtime P2P (`test_16_webxdc_realtime.py`)
- ارتباط لحظه‌ای P2P سرتاسری بین دو نمونه WebXDC را تأیید می‌کند.
- دست‌دادن Iroh را از طریق رله Iroh یکپارچه هماهنگ می‌کند.
- تأیید می‌کند که بسته‌های داده با فرکانس بالا با تأخیر کم خارج از جریان استاندارد IMAP/SMTP تحویل داده می‌شوند.

## پیش‌نیازها

- **محیط پایتون**: تست‌ها از `uv` برای مدیریت وابستگی‌ها استفاده می‌کنند.
- **سرور Delta Chat RPC**: فایل اجرایی `deltachat-rpc-server` باید روی سیستم نصب باشد.
- **دسترسی SSH**: برای تست‌هایی مانند "عدم ثبت لاگ" و برای دستورات مدیریتی، اجراکننده تست به دسترسی SSH به سرورهای راه دور نیاز دارد.
- **LXC (اختیاری)**: در صورت استفاده از پرچم `--lxc` اجراکننده به‌طور خودکار کانتینرهای ایزوله برای اجرای تست‌ها ایجاد می‌کند.

## نتایج و عیب‌یابی

نتایج تست‌ها، شامل لاگ‌های سمت کلاینت و لاگ‌های جمع‌آوری شده سمت سرور، در یک دایرکتوری با برچسب زمان در مسیر `tmp/test_run_YYYYMMDD_HHMMSS/` ذخیره می‌شوند:

- `client_debug.log`: لاگ‌های دقیق کلاینت RPC دلتاچت.
- `server1_debug.log` / `server2_debug.log`: گزارش‌های استخراج شده از `journalctl` در سرورهای ایمیل.
- `error.txt`: شامل جزئیات traceback در صورت شکست تست.
