---
title: یکپارچه‌سازی رله Iroh
description: نحوه ادغام رله Iroh در Madmail برای ارتباطات P2P لحظه‌ای و با کارایی بالا در WebXDC.
category: فنی
---

# یکپارچه‌سازی رله Iroh در Chatmail

این سند توضیح می‌دهد که یکپارچه‌سازی رله Iroh (که قبلاً با نام DERP شناخته می‌شد) در Madmail چگونه کار می‌کند؛ شامل کشف از طریق IMAP، سرور رله یکپارچه و هماهنگی P2P سمت کلاینت.

## نمای کلی

دلتاچت از پشته شبکه Iroh برای ارتباطات همتا‌به‌همتا (P2P) لحظه‌ای و با کارایی بالا، به‌ویژه برای برنامه‌های WebXDC استفاده می‌کند. از آنجایی که بسیاری از کاربران پشت NAT یا دیوار آتش هستند که مانع از اتصالات مستقیم می‌شود، یک **رله Iroh** به‌عنوان جایگزین (fallback) برای هدایت ترافیک رمزگذاری شده بین همتایان عمل می‌کند.

این سیستم از سه بخش اصلی تشکیل شده است:
۱. **افزونه متادیتای IMAP**: آدرس URL محلی رله Iroh را در اختیار کلاینت‌ها قرار می‌دهد.
۲. **رله Iroh یکپارچه**: یک پردازش جانبی (sidecar) یا سرویس یکپارچه که بسته‌های Iroh را رله می‌کند.
۳. **هسته Chatmail**: منطق ازدحام (swarm) P2P، پیوستن به موضوعات شایعه (gossip topics) و ارسال/دریافت داده‌های لحظه‌ای را مدیریت می‌کند.

## کشف از طریق IMAP

کلاینت‌های دلتاچت رله Iroh را با پرس‌وجو از سرور IMAP برای متادیتای خاص پیدا می‌کنند.

- **قابلیت IMAP**: سرور قابلیت `METADATA` را تبلیغ می‌کند (RFC 5464).
- **کلید متادیتا**: `/shared/vendor/deltachat/irohrelay`
- **درخواست**: `GETMETADATA "" /shared/vendor/deltachat/irohrelay`

سرور با آدرس URL کامل رله پاسخ می‌دهد، برای مثال: `http://mail.example.org:3340`.

## رله Iroh یکپارچه

Madmail نسخه خاصی از `iroh-relay` را (در حال حاضر نسخه **v0.35.0** برای مطابقت با نسخه هسته دلتاچت) به‌صورت یک سرویس جانبی یکپارچه همراه خود دارد.

### پشتیبانی از پروتکل‌ها
- **iroh-relay-v1**: رله پروتکل استاندارد Iroh را پیاده‌سازی می‌کند.
- **ارتقای وب‌ساکت (WebSocket Upgrade)**: اتصالات از طریق HTTP/HTTPS برقرار شده و با استفاده از زیرپروتکل `iroh-relay-v1` به پروتکل رله مبتنی بر وب‌ساکت ارتقا می‌یابند.

### احراز هویت
در پیاده‌سازی فعلی Chatmail/Madmail، رله با تنظیم `access = "everyone"` پیکربندی شده است. این کار به هر کاربر دلتاچت روی سرور اجازه می‌دهد بدون نیاز به تنظیمات اضافی از رله برای هماهنگی P2P استفاده کند.

## ارتباط P2P لحظه‌ای (WebXDC)

وقتی یک برنامه WebXDC درخواست اتصال لحظه‌ای می‌دهد:
۱. کلاینت آدرس URL رله را از طریق IMAP دریافت می‌کند.
۲. کلاینت به رله متصل شده و یک اتصال طولانی‌مدت دریافت می‌کند.
۳. کلاینت **شناسه نود (Node ID) Iroh** خود را از طریق پیام‌های استاندارد دلتاچت به سایر شرکت‌کنندگان اعلام می‌کند (تبلیغ لحظه‌ای).
۴. کلاینت‌ها از شناسه‌های نود اعلام شده و رله برای ایجاد یک ازدحام شایعه (gossip swarm) استفاده می‌کنند.
۵. داده‌ها در صورت امکان به‌صورت P2P و در غیر این صورت به‌عنوان جایگزین از طریق رله ارسال می‌شوند.

## پیکربندی

رله Iroh به‌طور پیش‌فرض در نصب‌های جدید Madmail فعال است. این تنظیم در فایل `maddy.conf` انجام می‌شود:

```hcl
endpoint.imap imap {
    # ... سایر تنظیمات ...
    iroh_relay_url http://$(public_ip):3340
}
```

خود رله به‌عنوان یک سرویس systemd (`iroh-relay.service`) با فایل پیکربندی در مسیر `/etc/maddy/iroh-relay.toml` مدیریت می‌شود:

```toml
enable_relay = true
http_bind_addr = "[::]:3340"
enable_stun = false
enable_metrics = false
access = "everyone"
```

> **توجه**: اگر سرور قبلاً یک سرویس اختصاصی TURN/STUN ارائه می‌دهد، معمولاً `enable_stun` در پیکربندی رله Iroh روی `false` تنظیم می‌شود تا از تداخل پورت‌ها جلوگیری شود.

## تست و تأیید

شما می‌توانید با استفاده از مجموعه تست E2E، یکپارچه‌سازی Iroh را تأیید کنید:

- **تست کشف**: `uv run python3 tests/deltachat-test/main.py --test-15`
- **تست P2P لحظه‌ای**: `uv run python3 tests/deltachat-test/main.py --test-16`

لاگ‌های سمت سرور را می‌توانید از این طریق بررسی کنید:
```bash
journalctl -u iroh-relay.service -f
```
