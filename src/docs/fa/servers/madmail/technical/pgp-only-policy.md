---
title: سیاست فقط ایمیل‌های PGP
description: نحوه اجبار ارتباطات فقط رمزگذاری شده از طریق PGP/MIME در Madmail و مدیریت دست‌دادن‌های Secure Join.
category: فنی
---

# سیاست فقط ایمیل‌های PGP

Madmail/Chatmail یک سیاست «فقط PGP» را اعمال می‌کند تا اطمینان حاصل شود که تمام ارتباطات به‌طور پیش‌فرض امن و خصوصی هستند. این سند توضیح می‌دهد که کدام درخواست‌های ایمیل توسط سرور پذیرفته و کدام‌یک رد می‌شوند.

## نمای کلی

سرور تمام پیام‌هایی را که از آن عبور می‌کنند، چه از طریق **SMTP** و چه از طریق **IMAP APPEND**، اعتبارسنجی می‌کند. قانون پیش‌فرض این است که فقط پیام‌های **PGP/MIME** که به‌درستی رمزگذاری شده‌اند، مجاز هستند.

## درخواست‌های پذیرفته شده

انواع پیام‌های زیر توسط سرور پذیرفته می‌شوند:

### ۱. پیام‌های رمزگذاری شده PGP/MIME
پیام‌ها باید دقیقاً از استاندارد [RFC 3156](https://tools.ietf.org/html/rfc3156) برای رمزگذاری PGP/MIME پیروی کنند:
- **Content-Type**: باید برابر با `multipart/encrypted; protocol="application/pgp-encrypted"` باشد.
- **ساختار**:
  - بخش اول باید `application/pgp-encrypted` با محتوای `Version: 1` باشد.
  - بخش دوم باید `application/octet-stream` شامل داده‌های معتبر OpenPGP باشد.

#### الگوریتم اعتبارسنجی
سرور بدون رمزگشایی، بازرسی عمیقی روی بدنه OpenPGP انجام می‌دهد:
- **مدیریت Armor**: اگر داده‌ها به‌صورت ASCII armored باشند، سرور محتوای Base64 را استخراج کرده، هدر `-----BEGIN PGP MESSAGE-----` و هدرهای اختیاری PGP و همچنین **چک‌سام CRC24** (خطوطی که با `=` شروع می‌شوند) را حذف می‌کند.
- **فرمت بسته‌ها**: تنها بسته‌های **فرمت جدید** (طبق RFC 4880 که با بیت‌های `0xC0` مشخص می‌شوند) پذیرفته می‌شوند.
- **کدگذاری طول**: الگوریتم به‌طور صحیح کدگذاری‌های طول یک‌بایتی، دوبایتی و پنج‌بایتی را مدیریت می‌کند.
- **طول‌های بدنه جزئی (Partial Body Lengths)**: طول‌های جزئی (۲۲۴-۲۵۴) را به‌طور تکراری پردازش می‌کند تا مرزهای بسته را دقیقاً محاسبه کند.
- **توالی بسته‌ها**:
  - تأیید می‌کند که بدنه شامل یک یا چند بسته **PKESK** (کلید نشست رمزگذاری شده با کلید عمومی، نوع ۱) یا **SKESK** (کلید نشست رمزگذاری شده متقارن، نوع ۳) باشد.
  - توالی **باید** دقیقاً با یک بسته **SEIPD** (داده‌های رمزگذاری شده متقارن و محافظت شده از نظر یکپارچگی، نوع ۱۸) خاتمه یابد.

### ۲. دست‌دادن (Handshake) Secure Join
برای اجازه به کاربران جهت برقراری یک اتصال تأیید شده (ایجاد اعتماد اولیه)، درخواست‌های اولیه Secure Join به‌صورت غیررمزگذاری شده پذیرفته می‌شوند:
- **هدرها**: شامل `Secure-Join: vc-request` یا `Secure-Join: vg-request`.
- **بدنه**: برابر با `secure-join: vc-request` یا `secure-join: vg-request` (بدون حساسیت به حروف بزرگ و کوچک).

### ۳. پیام‌های خودکار سیستم (Bounces)
برخی پیام‌های خودکار برای سلامت سیستم مجاز هستند:
- **فرستنده**: فرستنده پاکت نامه (Envelope From) باید `mailer-daemon@` باشد.
- **Content-Type**: باید `multipart/report` باشد.
- **Auto-Submitted**: باید موجود باشد و مقدار آن `no` نباشد.

### ۴. عبوردهی لیست سفید (Whitelisted Passthroughs)
مدیران می‌توانند استثناهای خاصی را پیکربندی کنند:
- **فرستندگان مجاز**: از طریق `passthrough_senders` تنظیم می‌شوند.
- **گیرندگان مجاز**: از طریق `passthrough_recipients` تنظیم می‌شوند (پشتیبانی از آدرس کامل یا دامنه به‌صورت `@example.com`).

---

## درخواست‌های رد شده

هر پیامی که معیارهای فوق را نداشته باشد، رد خواهد شد:

### ۱. متن ساده غیررمزگذاری شده
ایمیل‌های معمولی غیررمزگذاری شده با کد خطای **۵۲۳** رد می‌شوند.
- **خطای SMTP**: عبارت `523 Encryption Needed: Invalid Unencrypted Mail`
- **خطای IMAP**: عبارت `Encryption Needed: Invalid Unencrypted Mail`

### ۲. ساختار PGP نامعتبر
- نبود `Version: 1` در بخش اول `multipart/encrypted`.
- انواع بسته‌های غیرمنتظره (مانند بسته‌های داده متنی ساده یا امضا بدون رمزگذاری).
- کدگذاری طول خراب یا Base64 نامعتبر.
- وجود بیش از دو بخش در ساختار MIME.

### ۳. عدم تطابق هدرها
برای جلوگیری از جعل (Spoofing):
- آدرس **MIME From** باید دقیقاً با **فرستنده پاکت نامه** (MAIL FROM) مطابقت داشته باشد.
- عدم تطابق منجر به خطا می‌شود: `554 From header does not match envelope sender`.

### ۴. فرمت گیرنده نامعتبر
آدرس‌های بدشکل قبل از اعتبارسنجی رمزگذاری با کد **۵۵۴** رد می‌شوند.

## جزئیات پیاده‌سازی

منطق این بررسی‌ها در اجزای زیر پیاده‌سازی شده است:
- `internal/check/pgp_encryption/`: ماژول بررسی SMTP.
- `internal/pgp_verify/`: منطق اصلی اعتبارسنجی PGP و Secure Join.
- `internal/endpoint/imap/`: بسته‌بندی IMAP که این بررسی‌ها را روی دستورات `APPEND` اعمال می‌کند.
- `internal/endpoint/chatmail/`: نقطه انتهایی تحویل HTTP (MX-Deliv).
 Victorian
