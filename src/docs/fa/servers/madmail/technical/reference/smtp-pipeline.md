---
title: خط لوله SMTP
category: مرجع
---

# مسیریابی پیام SMTP (خط لوله)

یک خط لوله (pipeline) پیام، مجموعه‌ای از ارجاعات به ماژول‌ها و قوانین مرتبط است که نحوه مدیریت پیام‌ها را توصیف می‌کند.

خط لوله مسئول موارد زیر است:

- اجرای فیلترهای پیام (که «بررسی» یا "checks" نامیده می‌شوند)، (مانند تأیید امضای DKIM، جستجوی DNSBL و غیره).
- اجرای اصلاح‌کننده‌های پیام (modifiers) (مانند ایجاد امضای DKIM).
- مرتبط کردن هر گیرنده پیام با یک یا چند هدف تحویل (delivery targets).

یک هدف تحویل، ماژولی است که پردازش نهایی (تحویل) پیام را انجام می‌دهد.

## جریان مدیریت پیام

۱. اجرای بررسی‌های (checks) ارجاع شده در بلوک‌های `check` سطح بالا (در صورت وجود).
۲. اجرای اصلاح‌کننده‌های (modifiers) ارجاع شده در بلوک‌های `modify` سطح بالا (در صورت وجود).
۳. اگر بلوک‌های `source` وجود داشته باشند – بلوکی را انتخاب می‌کند که با فرستنده پیام (طبق آنچه در `MAIL FROM` مشخص شده) مطابقت دارد. اگر هیچ بلوک `source` وجود نداشته باشد – کل پیکربندی به‌عنوان بلوک `default_source` در نظر گرفته می‌شود.
۴. اجرای بررسی‌های ارجاع شده در بلوک‌های `check` در داخل بلوک `source` انتخاب شده (در صورت وجود).
۵. اجرای اصلاح‌کننده‌های ارجاع شده در بلوک‌های `modify` در داخل بلوک `source` انتخاب شده (در صورت وجود).

**سپس، برای هر گیرنده:**

۱. بلوک `destination` مطابق با آن را انتخاب می‌کند. اگر هیچ بلوک `destination` وجود نداشته باشد – کل بلوک `source` استفاده شده به‌گونه‌ای تفسیر می‌شود که گویی یک بلوک `default_destination` بوده است.
۲. اجرای بررسی‌های ارجاع شده در بلوک `check` در داخل بلوک `destination` انتخاب شده (در صورت وجود).
۳. اجرای اصلاح‌کننده‌های ارجاع شده در بلوک `modify` در داخل بلوک `destination` انتخاب شده (در صورت وجود).
۴. اگر بلوک استفاده شده شامل دستورالعمل `reject` باشد – گیرنده را با کد وضعیت SMTP مشخص شده رد می‌کند.
۵. اگر بلوک استفاده شده شامل دستورالعمل `deliver_to` باشد – پیام را به ماژول هدف مشخص شده منتقل می‌کند. تنها گیرندگانی که توسط بلوک استفاده شده مدیریت می‌شوند، برای آن هدف قابل مشاهده هستند.

هر گیرنده تنها توسط یک بلوک `destination` واحد مدیریت می‌شود؛ در صورت تداخل قوانین `destination` – اولین مورد اولویت دارد.

```hcl
destination example.org {
    deliver_to targetA
}
destination example.org { # مبهم است و اجازه داده نمی‌شود
    deliver_to targetB
}
```

همین موضوع برای بلوک‌های `source` نیز صادق است؛ هر پیام تنها توسط یک بلوک واحد مدیریت می‌شود.

هر بلوک گیرنده باید حداقل شامل یک دستورالعمل `deliver_to` یا دستورالعمل `reject` باشد. اگر از بلوک‌های `destination` استفاده می‌شود، باید از بلوک `default_destination` نیز برای تعیین رفتار در قبال گیرندگان نامشخص استفاده کرد. همین موضوع برای بلوک‌های فرستنده نیز صادق است: اگر از `source` استفاده می‌شود، باید از `default_source` نیز استفاده کرد.

پیکربندی خط لوله باید به‌طور صریح رفتار لازم برای هر ترکیب ممکن فرستنده/گیرنده را مشخص کند.

دستورالعمل‌هایی که تصمیمات نهایی مدیریت (`deliver_to` ، `reject`) را مشخص می‌کنند، نمی‌توانند در همان سطح قوانین `source`/`destination` استفاده شوند.

## دستورالعمل‌ها

### `check { ... }`
**بستر (Context):** پیکربندی خط لوله، بلوک source، بلوک destination

لیستی از ارجاعات ماژول برای بررسی‌هایی (checks) که باید روی پیام‌های مدیریت شده توسط بلوکی که `check` در آن قرار دارد، اجرا شوند.

بررسی‌های بدنه پیام قرار داده شده در بلوک‌های مقصد (destination blocks) در حال حاضر نادیده گرفته می‌شوند. با توجه به نحوه تعریف پروتکل SMTP، این کار باعث می‌شود پیام برای تمام گیرندگان رد شود، که معمولاً در این پیکربندی‌ها مطلوب نیست.

```hcl
check {
    # ارجاع به پیکربندی پیش‌فرض سیستم برای بررسی.
    spf

    # تعریف درجا با پیکربندی سفارشی.
    spf {
         permerr_action reject
    }
}
```

### `modify { ... }`
**بستر:** پیکربندی خط لوله، بلوک source، بلوک destination

لیستی از ارجاعات ماژول برای اصلاح‌کننده‌هایی (modifiers) که باید روی پیام‌های مدیریت شده توسط بلوکی که `modify` در آن قرار دارد، اجرا شوند.

اصلاح‌کننده‌ها پیام و متادیتای آن را قبل از تحویل نهایی پردازش می‌کنند. برای مثال، یک اصلاح‌کننده می‌تواند آدرس‌های گیرنده را جایگزین کند یا یک امضای DKIM اضافه کند.

**توجه:** اصلاح‌کننده‌هایی که بر آدرس فرستنده (source address) تأثیر می‌گذارند، فقط به‌صورت عمومی یا بر اساس هر منبع (per-source) قابل استفاده هستند؛ آن‌ها در داخل بلوک‌های مقصد (destination blocks) بی‌اثر هستند.

```hcl
modifiers local_modifiers {
    replace_rcpt file /etc/maddy/aliases
}

# ... جایی دیگر ...
{
    modify &local_modifiers
}
```

### `reject [code] [enhanced-code] [description]`
**بستر:** بلوک destination

پیام را با خطای SMTP مشخص شده رد می‌کند. اگر آرگومان‌ها حذف شوند، مقدار پیش‌فرض «پیام به دلایل سیاستی رد شد» (message is rejected due to policy reasons) خواهد بود.

```hcl
reject 541 5.4.0 "We don't like example.org, go away"
```

### `deliver_to [target]`
**بستر:** پیکربندی خط لوله، بلوک source، بلوک destination

پیام را به هدف تحویل (delivery target) ارجاع شده تحویل می‌دهد. در داخل یک بلوک `destination` ، تنها گیرندگان مطابقت یافته منتقل می‌شوند.

### `source_in [table] { ... }`
**بستر:** پیکربندی خط لوله

پیام‌هایی را مدیریت می‌کند که فرستنده پاکت‌نامه (envelope sender) آن‌ها در جدول مشخص شده موجود باشد. بر دستورالعمل‌های `source` اولویت دارد.

### `source [rules...] { ... }`
**بستر:** پیکربندی خط لوله

پیام‌های مطابق با قوانین آدرس فرستنده را مدیریت می‌کند. قوانین می‌توانند یک دامنه یا یک آدرس کامل باشند. مطابقت به حروف بزرگ و کوچک حساس نیست.

```hcl
source example.org {
    deliver_to &local_mailboxes
}
default_source {
    reject 521 5.0.0 "Forbidden"
}
```

### `reroute { ... }`
**بستر:** pipeline، source، destination

اجازه می‌دهد تصمیمات مسیریابی بر اساس نتیجه اصلاح‌کننده‌ها (مثلاً پس از گسترش مستعار) اتخاذ شود.

```hcl
destination example.org {
    modify {
        replace_rcpt file /etc/maddy/aliases
    }
    reroute {
        destination example.org {
            deliver_to &local_mailboxes
        }
        default_destination {
            deliver_to &remote_queue
        }
    }
}
```

### `destination_in [table] { ... }`
**بستر:** pipeline، source

گیرندگان پاکت‌نامه (envelope recipients) موجود در یک جدول را مدیریت می‌کند. بر قوانین `destination` اولویت دارد.

### `destination [rules...] { ... }`
**بستر:** pipeline، source

گیرندگان مطابق با قوانین (دامنه یا آدرس کامل) را مدیریت می‌کند.

## تکه‌کدهای قابل استفاده مجدد (`msgpipeline`)

خط لوله پیام می‌تواند مستقل از ماژول SMTP و از طریق ماژول `msgpipeline` استفاده شود.

```hcl
msgpipeline local_routing {
    destination whatever.com {
        deliver_to dummy
    }
}

# ... جایی دیگر ...
deliver_to &local_routing
```
 Victorian
