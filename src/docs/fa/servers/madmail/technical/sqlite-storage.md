---
title: Madmail و SQLite
description: بهترین شیوه‌ها و جزئیات فنی استفاده از SQLite به‌عنوان بک‌اِند ذخیره‌سازی در Madmail.
category: فنی
---

# maddy و SQLite

SQLite انتخابی عالی برای استقرارهای کوچک است، زیرا برای شروع به کار نیازی به هیچ پیکربندی اضافی ندارد. این پایگاه داده برای مواردی که کمتر از ۱۰ حساب کاربری ایمیل دارید توصیه می‌شود.

**توجه: SQLite برای نوشتن به قفل کردن کل دیتابیس (DB-wide locking) نیاز دارد، این بدان معناست که چندین پیام به‌طور موازی نمی‌توانند پذیرفته شوند. این موضوع در سیستم‌های مدیریت پایگاه داده رابطه‌ای (RDBMS) مبتنی بر سرور صادق نیست، جایی که maddy می‌تواند چندین پیام را به‌طور موازی حتی برای یک صندوق پستی واحد بپذیرد.**

## حالت WAL

maddy حالت ژورنال WAL را برای SQLite اجبار می‌کند. این کار سرعت را به‌طور معقولی افزایش داده و رقابت برای قفل را کاهش می‌دهد که برای یک سرور ایمیل معمولی مهم است.

maddy از بازه زمانی افزایش یافته autocheckpoint برای WAL استفاده می‌کند. این بدان معناست که با وجود حفظ توان خروجی بالای نوشتن، maddy باید هر بار که ۷۸ مگابایت در دیتابیس نوشته می‌شود (در پیکربندی پیش‌فرض ۱۵ مگابایت است) برای مدت کوتاهی (۰.۵ تا ۱ ثانیه) متوقف شود.

توجه داشته باشید که هنگام جابه‌جایی دیتابیس، باید فایل‌های ژورنال WAL (`-wal`) و حافظه مشترک (`-shm`) را نیز جابه‌جا کنید، در غیر این صورت برخی از تغییرات دیتابیس از دست خواهند رفت.

## آمار برنامه‌ریز کوئری (Query Planner Statistics)

maddy آمار برنامه‌ریز کوئری را هنگام خاموش شدن و هر ۵ ساعت یکبار به‌روزرسانی می‌کند. این کار اطلاعات لازم را برای دسترسی بهینه‌تر به دیتابیس در اختیار برنامه‌ریز کوئری قرار می‌دهد، زیرا اسکیما go-imap-sql از چند شاخص موسوم به «شاخص‌های کیفیت پایین» (low-quality indexes) استفاده می‌کند.

## Auto-vacuum

maddy ویژگی auto-vacuum در SQLite را روشن می‌کند. این بدان معناست که اندازه فایل دیتابیس با حذف داده‌ها کاهش می‌یابد (برخلاف حالت پیش‌فرض که فضای حذف شده بلااستفاده باقی می‌ماند).

## وکیوم دستی (Manual Vacuuming)

Auto-vacuuming می‌تواند منجر به پارگی دیتابیس (fragmentation) شود و در نتیجه عملکرد خواندن را کاهش دهد. برای انجام عملیات وکیوم دستی جهت بسته‌بندی مجدد و رفع پارگی فایل دیتابیس، ابزار کنسول SQLite3 را نصب کرده و دستورات زیر را اجرا کنید:

```bash
sqlite3 -cmd 'vacuum' database_file_path_here.db
sqlite3 -cmd 'pragma wal_checkpoint(truncate)' database_file_path_here.db
```

این کار مدتی طول می‌کشد تا کامل شود؛ وقتی اعلان `sqlite>` ظاهر شد، می‌توانید ابزار را ببندید.
