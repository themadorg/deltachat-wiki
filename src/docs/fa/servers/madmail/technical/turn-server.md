---
title: یکپارچه‌سازی سرور TURN
description: نحوه ادغام سرور TURN در Madmail برای تماس‌های WebRTC و ارائه کشف خودکار از طریق IMAP.
category: فنی
---

# یکپارچه‌سازی سرور TURN در Chatmail

این سند توضیح می‌دهد که یکپارچه‌سازی سرور TURN (عبور از لایه انتقال با استفاده از رله‌های اطراف NAT) در Madmail چگونه کار می‌کند؛ شامل کشف از طریق IMAP، احراز هویت مبتنی بر توکن و پیاده‌سازی داخلی سرور TURN.

## نمای کلی

دلتاچت از WebRTC برای تماس‌های صوتی و تصویری استفاده می‌کند. از آنجایی که بسیاری از کاربران پشت NAT یا دیوار آتش هستند، اغلب یک سرور TURN برای رله کردن ترافیک رسانه‌ای مورد نیاز است. Madmail یک سرور TURN یکپارچه و یک مکانیزم کشف برای کلاینت‌ها فراهم می‌کند.

این سیستم از سه بخش اصلی تشکیل شده است:
۱. **افزونه متادیتای IMAP**: جزئیات سرور TURN و اطلاعات شناسایی موقت را در اختیار کلاینت‌ها قرار می‌دهد.
۲. **نقطه انتهایی TURN**: یک سرور TURN داخلی که اطلاعات شناسایی را با استفاده از یک راز مشترک (Shared Secret) تأیید می‌کند.
۳. **هسته Chatmail**: منطق سمت کلاینت برای تجزیه اطلاعات سرور ICE و تبدیل نام‌های میزبان (Hostname resolution) را مدیریت می‌کند.

## کشف از طریق IMAP

کلاینت‌های دلتاچت سرور TURN را با پرس‌وجو از سرور IMAP برای متادیتای خاص پیدا می‌کنند.

- **قابلیت IMAP**: سرور قابلیت `METADATA` را تبلیغ می‌کند (RFC 5464).
- **کلید متادیتا**: `/shared/vendor/deltachat/turn`
- **درخواست**: `GETMETADATA "" /shared/vendor/deltachat/turn`

### تولید اطلاعات شناسایی موقت

وقتی یک کلاینت متادیتای TURN را درخواست می‌کند، سرور IMAP اطلاعات شناسایی موقت را با استفاده از مکانیزم **راز مشترک** تولید می‌کند:

۱. **نام کاربری**: یک مُهر زمانی یونیکس که نشان‌دهنده زمان انقضا است (مثلاً `زمان_فعلی + ۲۴ ساعت`).
۲. **رمز عبور**: یک امضای HMAC-SHA1 از نام کاربری که با استفاده از `turn_secret` محاسبه شده است.
۳. **فرمت خروجی**: `hostname:port:username:password`

این کار به سرور اجازه می‌دهد بدون ذخیره اطلاعات در دیتابیس، اطلاعات شناسایی معتبری برای مدت زمان محدود صادر کند.

## سرور TURN یکپارچه

سرور TURN در مسیر `internal/endpoint/turn/turn.go` با استفاده از کتابخانه `pion/turn` پیاده‌سازی شده است.

### جریان احراز هویت

وقتی یک کلاینت به سرور TURN متصل می‌شود:
۱. کلاینت `username` (مُهر زمانی انقضا) و `password` (امضای HMAC) را ارائه می‌دهد.
۲. سرور TURN بررسی می‌کند که آیا `realm` مطابقت دارد یا خیر.
۳. سرور TURN مجدداً HMAC-SHA1 نام کاربری ارائه شده را با استفاده از کپی خود از `turn_secret` محاسبه می‌کند.
۴. اگر امضای محاسبه شده با رمز عبور ارائه شده مطابقت داشته باشد، احراز هویت موفقیت‌آمیز است.

### تخصیص رله (Relay Allocation)
سرور از یک `MinimalRelayGenerator` برای تخصیص آدرس‌های رله استفاده می‌کند. این سرور از هر دو شنونده **UDP** و **TCP** پشتیبانی می‌کند. پیکربندی `relay_ip` تعیین می‌کند که سرور TURN چه آدرس IP را به کلاینت‌ها برای رله ترافیک اعلام کند.

## منطق هسته کلاینت (Rust)

هسته Rust (فایل `chatmail-core/src/calls.rs`) مدیریت لیست سرورهای ICE را بر عهده دارد:

- **تجزیه (Parsing)**: رشته متادیتای دریافت شده از IMAP را تجزیه می‌کند.
- **تبدیل (Resolution)**: نام‌های میزبان TURN/STUN را به آدرس‌های IP تبدیل می‌کند. این کار برای نسخه دسکتاپ دلتاچت که ممکن است در محیط‌هایی با DNS غیرقابل اعتماد کار کند، حیاتی است.
- **جایگزین (Fallback)**: اگر هیچ سرور TURN توسط متادیتای IMAP ارائه نشود، از سرورهای جایگزین هاردکد شده (مانند `turn.delta.chat`) استفاده می‌کند.

## پیکربندی

در فایل `maddy.conf` (یا پیکربندی معادل)، یکپارچه‌سازی TURN و TURNS به شکل زیر تنظیم می‌شود:

```hcl
endpoint.imap imap {
    # ... سایر تنظیمات ...
    turn_enable yes
    turn_server turn.example.com
    turn_port 443
    turn_secret "راز-مشترک-شما"
    turn_ttl 86400
    turn_prefer_tls yes  # TURNS را به‌عنوان پیش‌فرض اعلام می‌کند
}

endpoint.turn turn {
    realm example.com
    secret "راز-مشترک-شما"
    relay_ip 1.2.3.4
    
    # TLS اختیاری برای TURNS
    tls {
        cert /path/to/cert.pem
        key /path/to/key.pem
    }
}
```

### پشتیبانی از پروتکل‌ها

- **TURN**: پروتکل استاندارد روی UDP/TCP (معمولاً پورت ۳۴۷۸).
- **TURNS**: پروتکل TURN روی TLS (معمولاً پورت ۴۴۳ یا ۵۳۴۹). برای فعال کردن TURNS، از پیشوند `tls://` در آدرس‌های نقطه انتهایی `turn` استفاده کرده و یک بلوک `tls` ارائه دهید.

متادیتای IMAP اکنون از هر دو کلید `/shared/vendor/deltachat/turn` و `/shared/vendor/deltachat/turns` برای کشف توسط کلاینت پشتیبانی می‌کند.
