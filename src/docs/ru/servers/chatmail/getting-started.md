---
title: Настройка реле chatmail
description: Всё необходимое для настройки готового к использованию реле chatmail.
category: Серверы
---

<script>
    import Steps from '$lib/components/Steps.svelte';
    import Step from '$lib/components/Step.svelte';
</script>

# Настройка реле chatmail

В этом разделе содержится всё необходимое для настройки готового к использованию реле chatmail.
Автоматизированная настройка спроектирована и оптимизирована для предоставления адресов chatmail для немедленного подключения через приложения и ботов без получения предварительных разрешений.
Адреса Chatmail создаются автоматически при первом входе в систему, после чего для отправки и получения сообщений через них требуется первоначально указанный пароль.

## Минимальные требования и предварительные условия

Вам потребуется следующее:

- **Контроль над доменом** через любого DNS-провайдера по вашему выбору.
- **Сервер для развертывания с Debian 12**, на котором доступны порты SMTP/SUBMISSIONS/IMAPS/HTTPS. Наличие IPv6 приветствуется. Для серверов реле chatmail требуется всего 1 ГБ оперативной памяти, один процессор и около 10 ГБ на диске для поддержки нескольких тысяч активных адресов chatmail.
- **Локальная машина для сборки (Linux или Unix)** с доступом по SSH к пользователю root на сервере развертывания по ключу. Вы должны добавить в локальный ssh-agent приватный ключ, защищенный паролем, так как во время развертывания ввод пароля не предусмотрен. (Требуется приватный ключ ed25519 из-за [ошибки в библиотеке paramiko](https://github.com/paramiko/paramiko/issues/2191)).

## Настройка с помощью scripts/cmdeploy

В следующих шагах мы используем `chat.example.org` в качестве домена chatmail. Пожалуйста, замените его своим доменом.

<Steps>
<Step number="1" title="Настройка начальных DNS-записей">

Настройте начальные DNS-записи для вашего сервера развертывания. Ниже приведен пример в формате файлов зоны BIND с TTL 1 час (3600 секунд). Пожалуйста, подставьте свой домен и IP-адреса.

```text
chat.example.org. 3600 IN A 198.51.100.5
chat.example.org. 3600 IN AAAA 2001:db8::5
www.chat.example.org. 3600 IN CNAME chat.example.org.
mta-sts.chat.example.org. 3600 IN CNAME chat.example.org.
```

</Step>
<Step number="2" title="Клонирование репозитория">

Клонируйте репозиторий и инициализируйте виртуальную среду Python на вашем локальном ПК:

```sh
git clone https://github.com/chatmail/relay
cd relay
scripts/initenv.sh
```

</Step>
<Step number="3" title="Создание конфигурационного файла">

Создайте конфигурационный файл chatmail `chatmail.ini` на локальной машине для сборки:

```sh
scripts/cmdeploy init chat.example.org  # <-- используйте свой домен
```

</Step>
<Step number="4" title="Проверка входа по SSH">

Убедитесь, что вход по SSH под пользователем root на сервер развертывания работает:

```sh
ssh root@chat.example.org  # <-- используйте свой домен
```

</Step>
<Step number="5" title="Установка и настройка" isLast={true}>

Запустите установку и настройку удаленного сервера развертывания:

```sh
scripts/cmdeploy run
```

Этот сценарий также проверит наличие всех необходимых DNS-записей. Если записи отсутствуют, он порекомендует, какие именно нужно настроить у вашего DNS-провайдера.

</Step>
</Steps>

## Другие полезные команды

Чтобы проверить статус вашего сервера развертывания:
```sh
scripts/cmdeploy status
```

Чтобы отобразить и проверить все рекомендуемые DNS-записи:
```sh
scripts/cmdeploy dns
```

Чтобы проверить, корректно ли работает ваш сервис chatmail:
```sh
scripts/cmdeploy test
```

Чтобы измерить производительность вашего сервиса chatmail:
```sh
scripts/cmdeploy bench
```

## Редактирование домашней страницы

Команда `cmdeploy run` также создает статические веб-страницы по умолчанию и разворачивает их на веб-сервере Nginx:
- `index.html`: домашняя страница по умолчанию с QR-кодом для удобного подключения.
- `info.html`: страница с дополнительной информацией.
- `policy.html`: страница политики конфиденциальности.

Все `.html` файлы генерируются из соответствующих файлов markdown (`.md`) в директории `www/src`.

## Доработка веб-страниц

```sh
scripts/cmdeploy webdev
```
Эта команда запускает локальный цикл разработки веб-страниц chatmail, позволяя просматривать изменения в реальном времени.

## Пользовательские веб-страницы

Вы можете пропустить загрузку веб-страницы, установив `www_folder=disabled` в файле `chatmail.ini`.
Чтобы использовать собственную директорию для веб-страниц, укажите путь к ней в параметре `www_folder`. Команда `cmdeploy run` загрузит это содержимое как главную страницу сервера.

## Отключение автоматического создания адресов

Если вам нужно прекратить создание новых адресов, войдите на сервер по SSH и выполните:
```sh
touch /etc/chatmail-nocreate
```

## Миграция на новую машину для сборки

Чтобы перенести или добавить машину для сборки, клонируйте репозиторий на новую машину и скопируйте файл `chatmail.ini` со старой. Убедитесь, что установлен `rsync`, затем:

```sh
./scripts/initenv.sh
./scripts/cmdeploy dns
./scripts/cmdeploy status
```
