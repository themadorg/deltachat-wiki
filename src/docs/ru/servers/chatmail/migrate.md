---
title: Миграция на новую машину
description: Пошаговое руководство по безопасной миграции реле chatmail.
category: Серверы
---

<script>
    import Steps from '$lib/components/Steps.svelte';
    import Step from '$lib/components/Step.svelte';
</script>

# Миграция на новую машину

Это руководство по миграции содержит пошаговый подход к безопасному переносу реле chatmail с одной удаленной машины на другую.

## Предварительные замечания и допущения

- Если миграция планируется заранее, рекомендуется снизить время жизни (TTL) ваших DNS-записей до значения около 300 (5 минут). Лучше сделать это заблаговременно до фактической миграции. Это ускорит распространение изменений DNS в Интернете после завершения миграции.
- Шаги миграции были протестированы на ноутбуке с Linux; вам может потребоваться адаптировать некоторые команды под вашу локальную среду.
- Ваш почтовый домен (`mail_domain`) — `mail.example.org`.
- Обе удаленные машины работают под управлением Debian 12.
- IPv4-адрес старого сайта — `$OLD_IP4`.
- IP-адреса нового сайта — `$NEW_IP4` и `$NEW_IPV6`.

## Шесть шагов миграции

Обратите внимание, что на некоторых этапах вы можете получить предупреждение об изменении ключей SSH-хоста; в этом случае просто выполните `ssh-keygen -R "mail.example.org"`, как будет рекомендовано в сообщении.

<Steps>
<Step number="1" title="Первоначальный перенос почтовых ящиков">

Войдите на старый сайт, включив проброс ssh-agent с помощью `ssh -A`, чтобы иметь возможность копировать файлы со старого сайта на новый напрямую.

```sh
ssh -A root@$OLD_IP4
tar c /home/vmail/mail | ssh root@$NEW_IP4 "tar x -C /"
```

</Step>
<Step number="2" title="Предварительная настройка нового сайта">

Выполните предварительную настройку нового сайта, но оставьте его неактивным до шага 6:

```sh
CMDEPLOY_STAGES=install,configure scripts/cmdeploy run --ssh-host $NEW_IP4
```

</Step>
<Step number="3" title="Отключение почтовых сервисов на старом сайте">

Отключите почтовые сервисы на старом сайте. Пользователи не смогут отправлять или получать сообщения до завершения всех шагов. Другие реле и почтовые серверы будут время от времени пытаться доставить сообщения повторно, так что для пользователей ничего не будет потеряно.

```sh
scripts/cmdeploy run --disable-mail --ssh-host $OLD_IP4
```

</Step>
<Step number="4" title="Финальная синхронизация">

Финальная синхронизация секретов TLS/DKIM, очередей почты и почтовых ящиков. Снова используем проброс ssh-agent (`-A`) для прямой передачи всех важных данных со старого сайта на новый.

```sh
ssh -A root@$OLD_IP4
tar c /var/lib/acme /etc/dkimkeys /var/spool/postfix | ssh root@$NEW_IP4 "tar x -C /"
rsync -azH /home/vmail/mail root@$NEW_IP4:/home/vmail/
```

Войдите на новый сайт и убедитесь, что права владения файлами установлены корректно:

```sh
ssh root@$NEW_IP4
chown root: -R /var/lib/acme
chown opendkim: -R /etc/dkimkeys
chown vmail: -R /home/vmail/mail
```

</Step>
<Step number="5" title="Обновление DNS-записей">

Обновите DNS-записи, чтобы они указывали на новый сайт. Вам нужно изменить только записи `A` и `AAAA`, например:

```text
mail.example.org.    IN A    $NEW_IP4
mail.example.org.    IN AAAA $NEW_IP6
```

</Step>
<Step number="6" title="Активация реле на новом сайте" isLast={true}>

Активируйте реле chatmail на новом сайте:

```sh
CMDEPLOY_STAGES=activate scripts/cmdeploy run --ssh-host $NEW_IP4
```

</Step>
</Steps>

Вуаля! Пользователи смогут пользоваться реле, как только изменения DNS распространятся по сети.
