---
title: Спецификация аутентификации
description: Технические подробности регистрации «на лету» (JIT) и логики аутентификации в Madmail.
category: Техническая часть
---

# Спецификация аутентификации Chatmail

## Обзор
Chatmail реализует паттерн регистрации «на лету» (just-in-time). В отличие от традиционных почтовых серверов, требующих ручного создания учетных записей, Chatmail позволяет создавать их автоматически во время первой успешной попытки аутентификации (через IMAP или SMTP Submission).

## Логика аутентификации
Основная логика находится в модуле `auth.pass_table` (`internal/auth/pass_table/table.go`).

### Сценарий: Вход пользователя (IMAP/SMTP)
1.  **Нормализация**: Имя пользователя нормализуется (приведение регистра и очистка) с использованием PRECIS.
2.  **Поиск учетных данных**: Система пытается найти пользователя в таблице `passwords`.
3.  **Логика ветвления**:
    *   **Пользователь существует**: Выполняется стандартная проверка пароля (сравнение хешей Bcrypt).
    *   **Пользователь не существует**:
        *   Система запрашивает статус JIT-регистрации (`__JIT_REGISTRATION_ENABLED__`).
        *   Если `__JIT_REGISTRATION_ENABLED__` имеет значение `true`:
            *   Немедленно создается запись для нового пользователя.
            *   Предоставленный пароль хешируется и сохраняется.
            *   Попытка входа разрешается.
        *   Если `__JIT_REGISTRATION_ENABLED__` имеет значение `false`:
            *   Попытка входа отклоняется с ошибкой «Invalid Credentials».

## Технические детали реализации

### Архитектура модулей
- **Провайдер аутентификации**: `internal/auth/pass_table`
- **Бэкенд хранилища**: `internal/storage/imapsql`
- **Управление флагами**: `internal/table/sql_table`

### Динамическая конфигурация (таблица настроек)
Системные флаги отделены от учетных данных пользователей для обеспечения производительности и предотвращения конфликтов схем:
- **Имя таблицы**: `settings` (или как настроено в `maddy.conf` через `settings_table`).
- **Пара ключ-значение**: `__REGISTRATION_OPEN__` -> `"true"`/`"false"`.
- **Приоритет**: Если ключ отсутствует в таблице, система откатывается к статическому значению `auto_create`, определенному в `maddy.conf`.

Флаг JIT-регистрации (`__JIT_REGISTRATION_ENABLED__`) управляет автоматическим созданием учетных записей. Если он не задан явно, по умолчанию используется значение `__REGISTRATION_OPEN__`.

### Выделение почтового ящика
Когда пользователь автоматически регистрируется при входе, его почтовый ящик IMAP создается «лениво» при первом доступе или первой доставке почты.
- **Обработчик доставки**: `internal/storage/imapsql/delivery.go` также проверяет статус JIT-регистрации, чтобы определить, следует ли автоматически создавать несуществующего получателя во время доставки входящей почты.

## JIT vs Регистрация через API

Chatmail поддерживает два основных способа создания учетных записей:

1.  **JIT (Just-In-Time)**: Триггерится попыткой входа.
    - **Плюсы**: Отсутствие трения для пользователей.
    - **Минусы**: Может привести к «захвату адресов» или случайному созданию аккаунтов, если пароль не соответствует задуманной политике.
2.  **На базе API (`/new`)**: Триггерится POST-запросом к веб-эндпоинту.
    - **Плюсы**: Позволяет серверу контролировать генерацию имен пользователей и гарантировать уникальность до того, как клиент попытается войти.
    - **Контролируемый поток**: Даже если `__JIT_REGISTRATION_ENABLED__` имеет значение `false`, API `/new` всё равно будет работать, пока `__REGISTRATION_OPEN__` имеет значение `true`. Это позволяет операторам отключить автоматическое создание при входе, сохраняя возможность регистрации новых пользователей через официальную веб-страницу.

## Командная строка управления (CLI)
Статус регистрации можно переключать без перезапуска сервера:
```bash
maddy creds registration open   # Устанавливает __REGISTRATION_OPEN__ в true
maddy creds registration close  # Устанавливает __REGISTRATION_OPEN__ в false
```

JIT-регистрацией можно управлять независимо:
```bash
maddy creds jit enable   # Включить автоматическое создание аккаунтов
maddy creds jit disable  # Выключить автоматическое создание аккаунтов
maddy creds jit status   # Показать текущий статус JIT-регистрации
```
