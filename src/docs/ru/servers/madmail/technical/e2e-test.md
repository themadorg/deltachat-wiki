---
title: Набор E2E-тестов
description: Подробное описание набора E2E-тестов Delta Chat, используемого для проверки поведения и протоколов Madmail.
category: Техническая часть
---

# Набор E2E-тестов Delta Chat для Madmail

Этот документ описывает набор сквозных (E2E) тестов для сервера Madmail, который использует RPC-клиент Delta Chat для симуляции реального взаимодействия пользователей и проверки поведения сервера.

## Запуск тестов

### Сквозные тесты (End-to-End)
Основной набор E2E-тестов использует Delta Chat для проверки работы в реальных условиях:

```bash
make test
```

Эта команда запускает раннер тестов с помощью `uv`:
`uv run python3 tests/deltachat-test/main.py`

### Юнит-тесты
Для проверки внутренней логики на Go вы можете запустить юнит-тесты:

```bash
make test-unit
```

### Выборочное тестирование E2E

Вы можете запускать конкретные тесты или все тесты сразу, используя аргументы командной строки:

```bash
# Запустить все тесты (по умолчанию)
uv run python3 tests/deltachat-test/main.py --all

# Запустить конкретные тесты
uv run python3 tests/deltachat-test/main.py --test-1 --test-3
```

## Тестовые сценарии

Набор состоит из нескольких сценариев, расположенных в `tests/deltachat-test/scenarios/`:

### 1. Создание аккаунта (`test_01_account_creation.py`)
- Создает случайные тестовые аккаунты на указанных почтовых серверах.
- Использует формат `dclogin` для явного указания хостов IMAP/SMTP и обхода поиска в DNS.
- Проверяет, что аккаунт может быть успешно настроен и может начать ввод-вывод данных.

### 2. Отклонение незашифрованных сообщений (`test_02_unencrypted_rejection.py`)
- Пытается отправить обычное (незашифрованное) письмо через SMTP.
- Проверяет, что сервер Madmail корректно отклоняет его с кодом ошибки **523 "Encryption Needed"**.
- Это гарантирует соблюдение сервером политики «PGP-only».

### 3. Безопасное присоединение (Secure Join) (`test_03_secure_join.py`)
- Выполняет рукопожатие Secure Join между двумя аккаунтами.
- Проверяет, что обе стороны становятся «верифицированными контактами» и устанавливают защищенный канал с PGP-шифрованием.

### 4. P2P зашифрованное сообщение
- Отправляет зашифрованное одноранговое (P2P) сообщение между двумя верифицированными аккаунтами.
- Проверяет успешную доставку и расшифровку на стороне получателя.

### 5. Создание группы и сообщение (`test_05_group_message.py`)
- Создает новый групповой чат для нескольких пользователей.
- Добавляет в группу другого верифицированного контакта.
- Проверяет, что групповые сообщения корректно распределяются и получаются участниками.

### 6. Передача файлов (`test_06_file_transfer.py`)
- Генерирует случайный файл размером 1 МБ.
- Отправляет файл через Delta Chat.
- Проверяет целостность полученного файла путем сравнения его **SHA256-хеша** с оригиналом.

### 7. Федерация (`test_07_federation.py`)
- Проверяет обмен сообщениями между аккаунтами на разных инстансах Madmail.
- Проверяет обмен сообщениями между двумя аккаунтами на одном и том же инстансе.
- Гарантирует, что PGP-шифрование и доставка работают через границы серверов.

### 8. Тест на отсутствие логов (`test_08_no_logging.py`)
- Этот тест подтверждает принцип «приватность прежде всего».
- Он автоматически отключает логирование на удаленных серверах через SSH.
- Отправляет большой объем сообщений (более 30) в сценариях P2P, групп и федерации.
- Проверяет `journalctl`, чтобы убедиться, что во время этих операций логи не создавались (или создавались в минимальном объеме).
- Автоматически включает логирование обратно после завершения.

### 9. Передача больших файлов (`test_09_send_bigfile.py`)
- Стресс-тестирование конвейера SMTP/IMAP с несколькими большими вложениями.
- Проверяет, что настройки `appendlimit` и `max_message_size` корректно соблюдаются и обрабатываются.

### 10. Бинарная подпись и обновление (`test_10_upgrade_mechanism.py`)
- Проверяет работу механизма обновления бинарных файлов.
- Тестирует как успешные подписанные обновления, так и отклонение неподписанных или подделанных файлов.
- Симулирует обновления как из локальных файлов, так и по удаленным URL.

### 11. JIT-регистрация (`test_11_jit_registration.py`)
- Проверяет создание учетных записей «на лету» (Just-In-Time).
- Аккаунт создается автоматически при первом получении письма или попытке входа пользователя без предварительной ручной регистрации.

### 12. Тест SMTP/IMAP IDLE (`test_12_smtp_imap_idle.py`)
- Проверяет отзывчивость реализации IMAP IDLE.
- Тестирует получение сообщений в реальном времени без опроса сервера (polling).
- Гарантирует, что доставка по SMTP корректно триггерит уведомления IDLE.

### 14. Очистка сообщений (`test_14_purge_messages.py`)
- Проверяет административные команды для удаления пользовательских данных.
- Тестирует `purge-read` (удаляет сообщения, отмеченные как прочитанные).
- Тестирует `purge-all` (полностью очищает почтовый ящик аккаунта).
- Проверяет освобождение места в хранилище через серверную статистику.

### 15. Обнаружение Iroh (`test_15_iroh_discovery.py`)
- Проверяет, что сервер корректно сообщает адрес Iroh Relay через IMAP METADATA.
- Гарантирует, что клиент может получить и распарсить адрес реле для установления P2P-соединения.

### 16. WebXDC Realtime P2P (`test_16_webxdc_realtime.py`)
- Проверяет сквозную P2P-связь в реальном времени между двумя инстансами WebXDC.
- Координирует рукопожатие Iroh через интегрированное реле Iroh.
- Проверяет, что пакеты данных высокой частоты доставляются с низкой задержкой вне стандартного потока IMAP/SMTP.

## Предварительные условия

- **Среда Python**: Тесты используют `uv` для управления зависимостями.
- **Delta Chat RPC Server**: Бинарный файл `deltachat-rpc-server` должен быть установлен в системе.
- **SSH-доступ**: Для тестов типа «No Logging» и административных команд (Purge) раннеру необходим SSH-доступ к удаленным серверам.
- **LXC (опционально)**: При использовании флага `--lxc` раннер автоматически создаст изолированные контейнеры для запуска тестов.

## Результаты и отладка

Результаты тестов, включая логи на стороне клиента и собранные логи на стороне сервера, сохраняются в директории с временной меткой в `tmp/test_run_YYYYMMDD_HHMMSS/`:

- `client_debug.log`: подробные логи RPC-клиента Delta Chat.
- `server1_debug.log` / `server2_debug.log`: записи из `journalctl` на почтовых серверах.
- `error.txt`: содержит детали Traceback в случае провала теста.
