---
title: Интеграция реле Iroh
description: Как Madmail интегрирует реле Iroh для высокопроизводительной P2P-связи в реальном времени в WebXDC.
category: Техническая часть
---

# Интеграция реле Iroh в Chatmail

Этот документ объясняет, как работает интеграция реле Iroh (ранее DERP) в Madmail, охватывая процесс обнаружения через IMAP, работу интегрированного сервера реле и координацию P2P на стороне клиента.

## Обзор

Delta Chat использует сетевой стек Iroh для высокопроизводительной одноранговой (P2P) связи в реальном времени, особенно для приложений WebXDC. Поскольку многие пользователи находятся за NAT или брандмауэрами, которые препятствуют прямым соединениям, **реле Iroh** выступает в качестве запасного варианта для маршрутизации зашифрованного трафика между узлами.

Система состоит из трех основных частей:
1.  **Расширение метаданных IMAP**: предоставляет клиентам URL локального реле Iroh.
2.  **Интегрированное реле Iroh**: вспомогательный процесс или встроенный сервис, который ретранслирует пакеты Iroh.
3.  **Ядро Chatmail**: обрабатывает логику P2P-роя, присоединение к топикам сплетен (gossip) и отправку/получение данных в реальном времени.

## Обнаружение через IMAP

Клиенты Delta Chat находят реле Iroh, запрашивая у IMAP-сервера определенные метаданные.

-   **Возможность IMAP (Capability)**: сервер должен поддерживать `METADATA` (RFC 5464).
-   **Ключ метаданных**: `/shared/vendor/deltachat/irohrelay`
-   **Запрос**: `GETMETADATA "" /shared/vendor/deltachat/irohrelay`

Сервер отвечает полным URL-адресом реле, например: `http://mail.example.org:3340`.

## Интегрированное реле Iroh

Madmail поставляется с конкретной версией `iroh-relay` (в настоящее время **v0.35.0**, чтобы соответствовать версии ядра Delta Chat) в качестве интегрированного компонента.

### Поддержка протоколов
- **iroh-relay-v1**: реле реализует стандартный протокол реле Iroh.
- **Обновление до WebSocket (Upgrade)**: соединения устанавливаются через HTTP/HTTPS и обновляются до протокола реле на базе WebSocket с использованием подпротокола `iroh-relay-v1`.

### Аутентификация
В текущей реализации Chatmail/Madmail реле настроено с параметром `access = "everyone"`. Это позволяет любому пользователю Delta Chat на сервере использовать реле для P2P-координации без дополнительной настройки.

## P2P в реальном времени (WebXDC)

Когда приложение WebXDC запрашивает соединение в реальном времени:
1.  Клиент получает URL-адрес реле через IMAP.
2.  Клиент подключается к реле и получает долгоживущее соединение.
3.  Клиент сообщает свой **Iroh Node ID** другим участникам через стандартные сообщения Delta Chat (объявление в реальном времени).
4.  Участники используют полученные Node ID и реле для создания роя (gossip swarm).
5.  Данные отправляются напрямую P2P, где это возможно, или через реле как запасной вариант.

## Конфигурация

Реле Iroh включено по умолчанию в новых установках Madmail. Оно настраивается в файле `maddy.conf`:

```hcl
endpoint.imap imap {
    # ... другие настройки ...
    iroh_relay_url http://$(public_ip):3340
}
```

Само реле управляется как сервис systemd (`iroh-relay.service`), а его конфигурация находится в `/etc/maddy/iroh-relay.toml`:

```toml
enable_relay = true
http_bind_addr = "[::]:3340"
enable_stun = false
enable_metrics = false
access = "everyone"
```

> **Примечание**: Параметр `enable_stun` обычно устанавливается в `false` в конфигурации реле Iroh, если сервер уже предоставляет выделенный сервис TURN/STUN, чтобы избежать конфликтов портов.

## Тестирование и проверка

Вы можете проверить интеграцию Iroh, используя набор E2E-тестов:

- **Тест на обнаружение**: `uv run python3 tests/deltachat-test/main.py --test-15`
- **Тест P2P в реальном времени**: `uv run python3 tests/deltachat-test/main.py --test-16`

Логи на стороне сервера можно просмотреть с помощью команды:
```bash
journalctl -u iroh-relay.service -f
```
