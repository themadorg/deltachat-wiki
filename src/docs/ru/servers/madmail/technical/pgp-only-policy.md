---
title: Политика PGP-Only
description: Как Madmail обеспечивает общение только в зашифрованном виде через PGP/MIME и обрабатывает рукопожатия Secure Join.
category: Техническая часть
---

# Политика PGP-Only Email

Madmail/Chatmail принудительно соблюдает политику «PGP-Only», гарантируя, что всё общение является защищенным и приватным по умолчанию. Этот документ описывает, какие почтовые запросы принимаются сервером, а какие отклоняются.

## Обзор

Сервер проверяет каждое сообщение, проходящее через него, независимо от того, отправлено ли оно через **SMTP** или загружено через **IMAP APPEND**. По умолчанию разрешены только корректно зашифрованные сообщения в формате **PGP/MIME**.

## Принимаемые запросы

Сервер принимает сообщения следующих типов:

### 1. Зашифрованные сообщения PGP/MIME
Сообщения должны строго соответствовать стандарту [RFC 3156](https://tools.ietf.org/html/rfc3156) для шифрования PGP/MIME:
- **Content-Type**: `multipart/encrypted; protocol="application/pgp-encrypted"`
- **Структура**:
  - Первая часть должна быть `application/pgp-encrypted` с содержимым `Version: 1`.
  - Вторая часть должна быть `application/octet-stream`, содержащая валидные данные OpenPGP.

#### Алгоритм верификации
Сервер выполняет глубокую инспекцию полезной нагрузки OpenPGP без её расшифровки:
- **Обработка Armor**: Если данные в текстовом виде (ASCII armored), сервер извлекает Base64-содержимое, удаляя заголовок `-----BEGIN PGP MESSAGE-----`, опциональные PGP-заголовки и **контрольную сумму CRC24** (строки, начинающиеся с `=`).
- **Формат пакетов**: Принимаются только пакеты нового формата (**New Format**, согласно RFC 4880, обозначаются битами `0xC0`).
- **Кодирование длины**: Алгоритм корректно обрабатывает:
  - Кодирование длины в один, два и пять октетов.
  - **Частичная длина тела (Partial Body Lengths)**: Итеративно обрабатывает частичные значения длины (224-254) для точного определения границ пакетов.
- **Последовательность пакетов**:
  - Проверяет, что полезная нагрузка состоит из одного или нескольких пакетов **PKESK** (Public-Key Encrypted Session Key, тип 1) или **SKESK** (Symmetric-Key Encrypted Session Key, тип 3).
  - Последовательность **должна** заканчиваться ровно одним пакетом **SEIPD** (Symmetrically Encrypted and Integrity Protected Data, тип 18).

### 2. Рукопожатие Secure Join
Чтобы пользователи могли установить верифицированное соединение (начальная стадия доверия), первичные запросы Secure Join принимаются в незашифрованном виде:
- **Заголовки**: Содержит `Secure-Join: vc-request` или `Secure-Join: vg-request`.
- **Тело**: Равно `secure-join: vc-request` или `secure-join: vg-request` (без учета регистра).

### 3. Автоматические системные сообщения (Bounces)
Для поддержания работоспособности системы разрешены некоторые автоматические сообщения:
- **Отправитель**: Envelope from должен быть `mailer-daemon@`.
- **Content-Type**: `multipart/report`.
- **Auto-Submitted**: Должен присутствовать и иметь значение, отличное от `no`.

### 4. Белые списки (Whitelisted Passthroughs)
Администраторы могут настраивать исключения:
- **Разрешенные отправители**: Настраиваются через `passthrough_senders`.
- **Разрешенные получатели**: Настраиваются через `passthrough_recipients` (поддерживаются полные адреса или домены целиком `@example.com`).

---

## Отклоняемые запросы

Любое сообщение, не соответствующее вышеуказанным критериям, будет отклонено:

### 1. Незашифрованный обычный текст
Стандартные незашифрованные письма отклоняются с кодом ошибки **523**.
- **Ошибка SMTP**: `523 Encryption Needed: Invalid Unencrypted Mail`
- **Ошибка IMAP**: `Encryption Needed: Invalid Unencrypted Mail`

### 2. Неверная структура PGP
- Отсутствие `Version: 1` в первой части `multipart/encrypted`.
- Неожиданные типы пакетов (например, пакеты с открытыми данными или подписи без шифрования).
- Поврежденное кодирование длины или невалидный Base64.
- Более двух частей в структуре MIME.

### 3. Несоответствие заголовков
Для предотвращения подмены (spoofing):
- Адрес в заголовке **MIME From** должен точно совпадать с **адресом отправителя в конверте** (MAIL FROM).
- В случае несовпадения: `554 From header does not match envelope sender`.

### 4. Неверный формат получателя
Некорректно сформированные адреса отклоняются с кодом **554** еще до проверки шифрования.

## Детали реализации

Логика этих проверок реализована в следующих компонентах:
- `internal/check/pgp_encryption/`: модуль проверки SMTP.
- `internal/pgp_verify/`: основная логика валидации PGP и Secure Join.
- `internal/endpoint/imap/`: обертка IMAP, применяющая эти проверки к командам `APPEND`.
- `internal/endpoint/chatmail/`: эндпоинт доставки по HTTP (MX-Deliv).
