---
title: Синтаксис конфигурации
category: Справочник
---

# Синтаксис конфигурационных файлов

**Примечание:** Данный файл является техническим документом, описывающим правила парсинга конфигурационных файлов Madmail.

Конфигурация состоит из «директив», разделенных переносом строки. Каждая директива может иметь ноль или более аргументов.

```
directive0
directive1 arg0 arg1
```

Любая строка, начинающаяся с `#`, игнорируется. Пустые строки также игнорируются.

## Кавычки

Строки, содержащие пробелы, должны быть заключены в двойные кавычки, чтобы гарантировать их интерпретацию как единого аргумента.

```
directive0 two arguments
directive1 "one argument"
```

Строка, заключенная в кавычки, может содержать переносы строк, и они не будут интерпретироваться как разделитель директив.

```
directive0 "один длинный большой
аргумент для directive0"
```

Внутри литералов можно экранировать только кавычки: `\"`

Обратный слэш (`\`) в конце строки можно использовать для продолжения директивы на следующей строке.

## Блоки

Директива может иметь несколько поддиректив. Они записываются в блоке, заключенном в фигурные скобки `{ }`:
```
directive0 arg0 arg1 {
    subdirective0 arg0 arg1
    subdirective1 etc
}
```

Поддирективы также могут иметь блоки.

```
directive0 {
    subdirective0 {
        subdirective2 {
            a
            b
            c
        }
    }
    subdirective1 { }
}
```

Уровень вложенности ограничен, но при правильной конфигурации вы никогда не достигнете этого предела.

В большинстве случаев пустой блок эквивалентен его отсутствию:
```
directive { }
directive2 # то же самое, что и выше
```

## Переменные окружения

На переменные окружения можно ссылаться в конфигурации, используя синтаксис `$VARIABLE` или `{env:VARIABLENAME}`.

Несуществующие переменные разворачиваются в пустые строки и не удаляются из списка аргументов. В следующем примере `directive0` будет иметь один аргумент независимо от того, определена ли переменная `VAR`.

```
directive0 {env:VAR}
```

Парсер продожителен к ошибкам, и незавершенный плейсхолдер переменной (например, `{env:VAR`) будет оставлен как есть. Переменные разворачиваются и внутри кавычек тоже.

## Сниппеты и импорт

Вы можете повторно использовать блоки конфигурации, определяя их как «сниппеты». Сниппет — это просто директива с блоком, объявленная на верхнем уровне (не внутри других блоков), имя которой заключено в круглые скобки.

```
(snippetname) {
    a
    b
    c
}
```

Затем на сниппет можно сослаться с помощью мета-директивы `import`.

```
unrelated0
unrelated1
import snippetname
```

Приведенный выше пример будет развернут в следующую конфигурацию:

```
unrelated0
unrelated1
a
b
c
```

Инструкция `import` также может использоваться для включения содержимого из других файлов. Это работает точно так же, как со сниппетами, но вместо имени используется путь к файлу. Путь может быть либо относительным (относительно местоположения текущего обрабатываемого файла конфигурации), либо абсолютным. Если существуют и сниппет, и файл с одинаковым именем — будет использован сниппет.

```
# /etc/maddy/tls.conf
tls long_path_to_certificate long_path_to_private_key

# /etc/maddy/maddy.conf
smtp tcp://0.0.0.0:25 {
    import tls.conf
}
```

```
# Разворачивается в:
smtp tcp://0.0.0.0:25 {
    tls long_path_to_certificate long_path_to_private_key
}
```

Импортируемый файл может вводить новые сниппеты, и на них можно ссылаться в любом обрабатываемом файле конфигурации.

## Значения длительности (Duration)

Директивы, принимающие длительность, используют следующий формат: последовательность десятичных цифр с необязательной дробной частью и суффиксом единицы измерения (ноль можно указывать без суффикса). Если указано несколько значений, они будут суммированы.

Допустимые суффиксы: `h` (часы), `m` (минуты), `s` (секунды), `ms` (миллисекунды). Реализация также принимает `us` и `ns` для микросекунд и наносекунд, но на практике эти значения бесполезны.

Примеры:
```
1h
1h 5m
1h5m
0
```

## Значения размера данных

Аналогично значениям длительности, но дробные части не допускаются, а суффиксы отличаются.

Допустимые суффиксы: `G` (гибибайт, 1024³ байт), `M` (мебибайт, 1024² байт), `K` (кибибайт, 1024 байт), `B` или `b` (байт).

Примеры:
```
32M
3M 5K
5b
```

Также обратите внимание, что следующая запись является невалидной, в отличие от синтаксиса значений длительности:
```
32M5K
```

## Определения адресов

В конфигурации Madmail используется синтаксис, похожий на URL, для указания сетевых адресов.

- `unix://путь_к_файлу` — сокет домена Unix. Относительные пути отсчитываются от директории рантайма (`/run/maddy`).
- `tcp://ADDRESS:PORT` — сокет TCP/IP.
- `tls://ADDRESS:PORT` — сокет TCP/IP с использованием TLS.

## Модуль Dummy

Пустой модуль (no-op). Его не нужно настраивать явно, на него можно ссылаться по имени `dummy`. Он может выступать в роли цели доставки (delivery target) или провайдера аутентификации. В последнем случае он будет принимать любые учетные данные, позволяя любому клиенту аутентифицироваться с любым именем пользователя и паролем (используйте с осторожностью!).
