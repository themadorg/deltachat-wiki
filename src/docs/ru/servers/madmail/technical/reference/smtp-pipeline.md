---
title: Конвейер SMTP
category: Справочник
---

# Маршрутизация сообщений SMTP (конвейер)

Конвейер сообщений (pipeline) — это набор ссылок на модули и связанных с ними правил, описывающих способ обработки сообщений.

Конвейер отвечает за:

- Запуск фильтров сообщений (называемых проверками «checks»), например: верификация подписи DKIM, поиск в DNSBL и т. д.
- Запуск модификаторов сообщений (например, создание подписи DKIM).
- Сопоставление каждого получателя сообщения с одним или несколькими целями доставки.

Цель доставки (delivery target) — это модуль, который выполняет конечную обработку (доставку) сообщения.

## Процесс обработки сообщения

1. Выполнение проверок, указанных в блоках `check` на верхнем уровне (если есть).
2. Выполнение модификаторов, указанных в блоках `modify` на верхнем уровне (если есть).
3. Если есть блоки `source` — выбор того, который соответствует отправителю сообщения (указанному в `MAIL FROM`). Если блоков `source` нет — вся конфигурация считается блоком `default_source`.
4. Выполнение проверок, указанных в блоках `check` внутри выбранного блока `source` (если есть).
5. Выполнение модификаторов, указанных в блоках `modify` внутри выбранного блока `source` (если есть).

**Затем для каждого получателя:**

1. Выбор блока `destination`, который ему соответствует. Если блоков `destination` нет — весь используемый блок `source` интерпретируется как блок `default_destination`.
2. Выполнение проверок, указанных в блоке `check` внутри выбранного блока `destination` (если есть).
3. Выполнение модификаторов, указанных в блоке `modify` внутри выбранного блока `destination` (если есть).
4. Если используемый блок содержит директиву `reject` — отклонение получателя с указанным кодом статуса SMTP.
5. Если используемый блок содержит директиву `deliver_to` — передача сообщения указанному целевому модулю. Модулю доставки видны только те получатели, которые обрабатываются данным блоком.

Каждый получатель обрабатывается только одним блоком `destination`; в случае пересечения правил `destination` приоритет имеет первое по порядку правило.

```
destination example.org {
    deliver_to targetA
}
destination example.org { # неоднозначно и поэтому не допускается
    deliver_to targetB
}
```

То же самое касается блоков `source`: каждое сообщение обрабатывается только одним блоком.

Каждый блок получателя должен содержать хотя бы одну директиву `deliver_to` или `reject`. Если используются блоки `destination`, то должен использоваться и блок `default_destination` для определения поведения для не подошедших под правила получателей. То же самое для блоков источника: `default_source` должен использоваться, если используется `source`.

Конфигурация конвейера должна явно указывать поведение для каждой возможной комбинации отправителя и получателя.

Директивы, задающие финальные решения по обработке (`deliver_to`, `reject`), не могут использоваться на том же уровне, что и правила `source`/`destination`.

## Директивы

### `check { ... }`
**Контекст:** конфигурация конвейера, блок source, блок destination

Список ссылок на модули для проверок, которые должны быть выполнены для сообщений, обрабатываемых блоком, в котором размещен `check`.

Проверки тела сообщения (body checks), размещенные в блоках `destination`, в настоящее время игнорируются. Из-за особенностей протокола SMTP они привели бы к отклонению сообщения для всех получателей сразу, что обычно не является желаемым поведением в таких конфигурациях.

```
check {
    # Ссылка на неявно определенную конфигурацию проверки по умолчанию.
    spf

    # Встроенное определение пользовательской конфигурации.
    spf {
         permerr_action reject
    }
}
```

### `modify { ... }`
**Контекст:** конфигурация конвейера, блок source, блок destination

Список ссылок на модули для модификаторов, которые должны быть выполнены для сообщений, обрабатываемых блоком, в котором размещен `modify`.

Модификаторы обрабатывают сообщение и его метаданные перед финальной доставкой. Например, модификатор может заменить адреса получателей или добавить подпись DKIM.

**Примечание:** Модификаторы, влияющие на адрес отправителя, могут использоваться только глобально или для конкретного источника; они не работают (no-op) внутри блоков `destination`.

```
modifiers local_modifiers {
    replace_rcpt file /etc/maddy/aliases
}

# ... где-то в другом месте ...
{
    modify &local_modifiers
}
```

### `reject [code] [enhanced-code] [description]`
**Контекст:** блок destination

Отклоняет сообщение с указанной ошибкой SMTP. Если аргументы опущены, по умолчанию используется «message is rejected due to policy reasons» (сообщение отклонено по соображениям политики).

```
reject 541 5.4.0 "We don't like example.org, go away"
```

### `deliver_to [target]`
**Контекст:** конфигурация конвейера, блок source, блок destination

Доставляет сообщение на указанную цель доставки. Внутри блока `destination` передаются только соответствующие ему получатели.

### `source_in [table] { ... }`
**Контекст:** конфигурация конвейера

Обрабатывает сообщения с отправителями в конверте, присутствующими в указанной таблице. Имеет приоритет над директивами `source`.

### `source [rules...] { ... }`
**Контекст:** конфигурация конвейера

Обрабатывает сообщения, соответствующие правилам адреса отправителя. Правилом может быть домен или полный адрес. Сравнение нечувствительно к регистру.

```
source example.org {
    deliver_to &local_mailboxes
}
default_source {
    reject 521 5.0.0 "Forbidden"
}
```

### `reroute { ... }`
**Контекст:** pipeline, source, destination

Позволяет принимать решения о маршрутизации на основе результата работы модификаторов (например, после раскрытия алиасов).

```
destination example.org {
    modify {
        replace_rcpt file /etc/maddy/aliases
    }
    reroute {
        destination example.org {
            deliver_to &local_mailboxes
        }
        default_destination {
            deliver_to &remote_queue
        }
    }
}
```

### `destination_in [table] { ... }`
**Контекст:** pipeline, source

Обрабатывает получателей в конверте, присутствующих в таблице. Имеет приоритет над правилами `destination`.

### `destination [rules...] { ... }`
**Контекст:** pipeline, source

Обрабатывает получателей, соответствующих правилам (домен или полный адрес).

## Многоразовые компоненты (`msgpipeline`)

Конвейер сообщений можно использовать независимо от модуля SMTP через модуль `msgpipeline`.

```
msgpipeline local_routing {
    destination whatever.com {
        deliver_to dummy
    }
}

# ... где-то в другом месте ...
deliver_to &local_routing
```
