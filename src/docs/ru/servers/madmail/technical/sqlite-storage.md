---
title: Madmail и SQLite
description: Рекомендации и технические подробности использования SQLite в качестве хранилища для Madmail.
category: Техническая часть
---

# maddy и SQLite

SQLite — идеальный выбор для небольших инсталляций, так как для начала работы не требуется никакой дополнительной настройки. Рекомендуется для случаев, когда у вас менее 10 почтовых аккаунтов.

**Примечание: SQLite требует блокировки всей базы данных для записи, что означает невозможность параллельного приема нескольких сообщений. Это не относится к серверным СУБД, где maddy может принимать несколько сообщений параллельно даже для одного почтового ящика.**

## Режим WAL

maddy принудительно включает режим журнала WAL для SQLite. Это обеспечивает приемлемую скорость работы и снижает конфликты блокировок, что важно для типичного почтового сервера.

maddy использует увеличенный интервал автоматических чекпоинтов WAL. Это означает, что при высокой нагрузке на запись maddy будет делать небольшие паузы (0,5–1 секунда) каждые 78 МиБ записанных данных в БД (при стандартной конфигурации — каждые 15 МиБ).

Обратите внимание, что при переносе базы данных необходимо также переносить файлы журнала WAL (`-wal`) и файлы общей памяти (`-shm`), иначе некоторые изменения в БД будут потеряны.

## Статистика планировщика запросов

maddy обновляет статистику планировщика запросов при выключении и каждые 5 часов. Это предоставляет планировщику информацию для более эффективного доступа к базе данных, так как схема `go-imap-sql` использует несколько так называемых «низкокачественных индексов».

## Auto-vacuum

maddy включает функцию `auto-vacuum` в SQLite. Это означает, что размер файла базы данных будет уменьшаться при удалении данных (в отличие от стандартного поведения, когда место остается неиспользуемым).

## Ручная очистка (Vacuum)

Функция `auto-vacuum` может привести к фрагментации базы данных и снижению производительности чтения. Для выполнения ручной очистки, перепаковки и дефрагментации файла БД установите утилиту командной строки `sqlite3` и выполните следующие команды:
```
sqlite3 -cmd 'vacuum' путь_к_файлу_базы_данных.db
sqlite3 -cmd 'pragma wal_checkpoint(truncate)' путь_к_файлу_базы_данных.db
```

Это займет некоторое время. Вы сможете закрыть утилиту, когда появится приглашение `sqlite>`.
