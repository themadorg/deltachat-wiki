---
title: Интеграция TURN-сервера
description: Как Madmail интегрирует TURN-сервер для WebRTC-звонков и обеспечивает автоматическое обнаружение через IMAP.
category: Техническая часть
---

# Интеграция TURN-сервера в Chatmail

Этот документ объясняет, как работает интеграция TURN-сервера (Traversal Using Relays around NAT) в Madmail, охватывая обнаружение через IMAP, аутентификацию на основе токенов и внутреннюю реализацию TURN-сервера.

## Обзор

Delta Chat использует WebRTC для аудио- и видеозвонков. Поскольку многие пользователи находятся за NAT или брандмауэрами, для ретрансляции медиатрафика часто требуется TURN-сервер. Madmail предоставляет встроенный TURN-сервер и механизм его обнаружения для клиентов.

Система состоит из трех основных частей:
1.  **Расширение метаданных IMAP**: предоставляет клиентам данные TURN-сервера и временные учетные данные.
2.  **Эндпоинт TURN**: интегрированный TURN-сервер, который проверяет учетные данные с помощью общего секрета.
3.  **Ядро Chatmail**: обрабатывает клиентскую логику парсинга информации о серверах ICE и разрешения доменных имен.

## Обнаружение через IMAP

Клиенты Delta Chat находят TURN-сервер, запрашивая у IMAP-сервера определенные метаданные.

-   **Возможность IMAP (Capability)**: сервер сообщает о поддержке `METADATA` (RFC 5464).
-   **Ключ метаданных**: `/shared/vendor/deltachat/turn`
-   **Запрос**: `GETMETADATA "" /shared/vendor/deltachat/turn`

### Генерация временных учетных данных

Когда клиент запрашивает метаданные TURN, IMAP-сервер генерирует временные учетные данные, используя механизм **общего секрета (Shared Secret)**:

1.  **Имя пользователя (Username)**: Unix-таймштамп, указывающий время истечения (например, `текущее_время + 24ч`).
2.  **Пароль (Password)**: подпись HMAC-SHA1 от имени пользователя, рассчитанная с использованием `turn_secret`.
3.  **Формат вывода**: `хост:порт:пользователь:пароль`

Это позволяет серверу выдавать учетные данные, действительные в течение ограниченного времени, не сохраняя их в базе данных.

## Интегрированный TURN-сервер

TURN-сервер реализован в `internal/endpoint/turn/turn.go` с использованием библиотеки `pion/turn`.

### Процесс аутентификации

Когда клиент подключается к TURN-серверу:
1.  Клиент предоставляет `username` (таймштамп истечения) и `password` (подпись HMAC).
2.  TURN-сервер проверяет соответствие области (`realm`).
3.  TURN-сервер заново рассчитывает HMAC-SHA1 предоставленного имени пользователя (`username`), используя свою копию `turn_secret`.
4.  Если рассчитанная подпись совпадает с предоставленным паролем, аутентификация считается успешной.

### Выделение реле (Relay Allocation)
Сервер использует `MinimalRelayGenerator` для выделения адресов реле. Поддерживаются слушатели как **UDP**, так и **TCP**. Настройка `relay_ip` определяет IP-адрес, который TURN-сервер сообщает клиентам для использования в качестве реле.

## Логика ядра клиента (Rust)

Ядро на Rust (`chatmail-core/src/calls.rs`) управляет списком серверов ICE:

-   **Парсинг**: разбирает строку метаданных, полученную от IMAP.
-   **Разрешение имен (Resolution)**: разрешает хостнеймы TURN/STUN в IP-адреса. Это критично для Delta Chat Desktop, который может работать в средах, где разрешение DNS ненадежно или недоступно приложению.
-   **Запасной вариант (Fallback)**: если TURN-сервер не предоставлен через метаданные IMAP, используются зашитые в код резервные серверы (например, `turn.delta.chat`).

## Конфигурация

В `maddy.conf` (или аналогичном конфигурационном файле) интеграция TURN и TURNS настраивается следующим образом:

```hcl
endpoint.imap imap {
    # ... другие настройки ...
    turn_enable yes
    turn_server turn.example.com
    turn_port 443
    turn_secret "ваш-общий-секрет"
    turn_ttl 86400
    turn_prefer_tls yes  # Рекламирует TURNS как вариант по умолчанию
}

endpoint.turn turn {
    realm example.com
    secret "ваш-общий-секрет"
    relay_ip 1.2.3.4
    
    # Опционально TLS для TURNS
    tls {
        cert /path/to/cert.pem
        key /path/to/key.pem
    }
}
```

### Поддержка протоколов

-   **TURN**: стандартный TURN через UDP/TCP (обычно порт 3478).
-   **TURNS**: TURN через TLS (обычно порт 443 или 5349). Чтобы включить TURNS, используйте префикс `tls://` в адресах эндпоинта `turn` и укажите блок `tls`.

Метаданные IMAP теперь поддерживают ключи как `/shared/vendor/deltachat/turn`, так и `/shared/vendor/deltachat/turns` для обнаружения клиентами.
