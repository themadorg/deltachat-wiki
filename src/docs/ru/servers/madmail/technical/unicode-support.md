---
title: Поддержка Unicode
description: Информация о первоклассной поддержке Unicode в Madmail, интернационализированной электронной почте и соблюдении профилей PRECIS.
category: Техническая часть
---

# Поддержка Unicode

maddy обладает первоклассной поддержкой Unicode во всех компонентах (модулях). Вам не нужно предпринимать никаких действий, чтобы обеспечить работу с интернационализированными доменами, именами почтовых ящиков или не-ASCII заголовками сообщений.

Внутри системы все текстовые поля в maddy представлены в кодировке UTF-8 и обрабатываются с использованием операций, учитывающих Unicode, для сравнения, приведения регистра и т. д.

## Данные в кодировках, отличных от ASCII, в заголовках и телах сообщений

Реализация SMTP в maddy не учитывает кодировки, используемые в заголовках MIME или в поле `charset` заголовка `Content-Type text/*`.

Однако реализация локального хранилища IMAP должна выполнять определенные операции над содержимым заголовков. В основном это касается функциональности поиска (SEARCH). Чтобы поиск IMAP работал корректно, тело сообщения и заголовки должны использовать одну из следующих кодировок:

- ASCII
- UTF-8
- ISO-8859-1, 2, 3, 4, 9, 10, 13, 14, 15 или 16
- Windows-1250, 1251 или 1252 (также известные как Code Page 1250 и т.д.)
- KOI8-R
- ~~HZGB2312~~, GB18030
- GBK (также известная как Code Page 936)
- Shift JIS (также известная как Code Page 932 или Windows-31J)
- Big-5 (также известная как Code Page 950)
- EUC-JP
- ISO-2022-JP

_Поддержка HZGB2312 в данный момент отключена из-за ошибок, влияющих на безопасность._

Если почтовый ящик содержит сообщение в кодировке, не указанной в этом списке, оно не будет возвращено в результатах поиска ни по одному запросу.

Поведение, касающееся обработки кодировок, отличных от Unicode, не считается стабильным и может измениться между версиями (вплоть до удаления поддержки определенных кодировок). Если вам нужно, чтобы всё работало корректно — переходите на использование UTF-8.

## Конфигурационные файлы

Предполагается, что конфигурационные файлы maddy закодированы в UTF-8. Использование любой другой кодировки приведет к ошибкам в работе, не делайте этого.

Доменные имена (например, в директиве `hostname` или правилах конвейера) могут быть представлены в форме ACE (также известной как Punycode). Внутренне они будут преобразованы в форму Unicode.

## Локальные учетные данные

Бэкенд хранилища 'sql' и провайдер аутентификации накладывают ряд дополнительных ограничений на используемые имена аккаунтов.

Для локальных адресов электронной почты применяется профиль PRECIS UsernameCaseMapped.
Он ограничивает использование управляющих и Bidi-символов (двунаправленного письма), чтобы гарантировать единообразное представление используемого значения в различных контекстах. Кроме того, адрес приводится к нижнему регистру и нормализуется в форму NFC для согласованной внутренней обработки.

Для паролей применяется профиль PRECIS OpaqueString. Здесь действуют менее строгие правила. Последовательности символов пробела Unicode заменяются одним пробелом ASCII. После этого применяется нормализация NFC. Если результирующая строка оказывается пустой — пароль не принимается.

Оба профиля определены в RFC 8265, обратитесь к нему для получения подробностей.

## Поддержка протоколов

### Расширение SMTPUTF8

Реализация SMTP в maddy включает поддержку расширения SMTPUTF8, как определено в RFC 6531.

Это означает, что maddy может обрабатывать интернационализированные имена почтовых ящиков и доменов в командах MAIL FROM, RCPT TO как для исходящей, так и для входящей доставки.

maddy не примет сообщения с не-ASCII адресами в конверте, если не запрошена поддержка SMTPUTF8. Если сообщение с установленным флагом SMTPUTF8 пересылается на сервер без поддержки SMTPUTF8, доставка не удастся, если только невозможно представить адреса в конверте в форме ASCII (когда только домены используют Unicode, они могут быть преобразованы в Punycode). Содержимое тела сообщения (и заголовок) не учитывается и всегда принимается и отправляется «как есть», автоматическое понижение версии или перекодирование не производится.

### Расширения IMAP UTF8, I18NLEVEL

В настоящее время maddy не поддерживает расширения IMAP UTF8 и I18NLEVEL. Однако это не является проблемой, препятствующей корректной обработке сообщений в UTF-8 (или даже сообщений в других кодировках, не относящихся к Unicode, упомянутых выше).

Клиенты, которые хотят реализовать правильную обработку строк Unicode, могут полагать, что maddy не обрабатывает их должным образом, например, в командах SEARCH, и поэтому такие клиенты могут загружать сообщения и обрабатывать их локально.
